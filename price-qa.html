<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Price Q&A</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; padding: 1rem; line-height: 1.4; }
  h1 { margin-top: 0; }
  #controls { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; }
  #question { flex: 1 1 420px; padding: .5rem; font-size: 1rem; }
  button { padding: .55rem .9rem; font-size: .95rem; cursor: pointer; }
  #status { font-size: .85rem; color: #555; margin-top: .5rem; }
  #result { white-space: pre-wrap; background: #f7f7f7; padding: .75rem; border-radius: 6px; border: 1px solid #e2e2e2; margin-top: 1rem; max-height: 55vh; overflow: auto; }
  .dim { opacity: .6; }
  footer { margin-top: 2rem; font-size: .75rem; color: #666; }
  mark { background: #ffec99; padding: 0 2px; }
</style>
</head>
<body>
<h1>Price Q&A</h1>
<div id="controls">
  <input id="question" placeholder="輸入關鍵字 (例: 1.6 NULUX 藍光 海外)" size="50" />
  <button id="searchBtn" onclick="search()">Search</button>
  <button id="clearBtn" onclick="clearQuery()" class="dim">Clear</button>
</div>
<div id="status">Loading data…</div>
<div id="summary" style="margin-top:.5rem;font-size:.9rem;color:#222;background:#eef6ff;padding:.6rem .75rem;border:1px solid #c3e1ff;border-radius:6px;display:none"></div>
<pre id="result">(No results yet)</pre>

<script>
let rows = [];
let loaded = false;
let lastQuery = '';
const BRAND_MAP = { '1.6':'NULUX (manual)', '1.67':'NULUX (manual)' };// edit as needed

const questionEl = document.getElementById('question');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const searchBtn = document.getElementById('searchBtn');
const clearBtn = document.getElementById('clearBtn');

// Load data
fetch('prices.json', { cache: 'no-store' })
  .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
  .then(d => { rows = Array.isArray(d) ? d : []; loaded = true; statusEl.textContent = `Loaded ${rows.length} records`; })
  .catch(err => { statusEl.textContent = 'Failed to load prices.json: ' + err.message; statusEl.style.color = '#b00020'; });

function norm(s){ return (s||'').toLowerCase().trim(); }
function tokenize(q){ return norm(q).split(/\s+/).filter(t => t); }
function clearQuery(){ questionEl.value=''; resultEl.textContent='(No results)'; statusEl.textContent = loaded ? `Loaded ${rows.length} records` : 'Not loaded'; clearBtn.classList.add('dim'); lastQuery=''; }
function highlight(line, tokens){ let out=line; tokens.forEach(t=>{ const re=new RegExp('(' + t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')','ig'); out = out.replace(re,'<mark>$1</mark>'); }); return out; }
function matchRow(row, tokens){
  const combined=[row.series,row.subseries,row.index,row.coating,row.source_file,row.effective_date].map(v=>norm(v)).join(' ');
  return tokens.every(tok=>{
    if(tok==='海外'||tok==='overseas') return !!row.overseas;
    if(tok==='本地'||tok==='local') return !row.overseas;
    if(/^\d+(?:\.\d+)?$/.test(tok)) return norm(row.index)===tok;
    return combined.includes(tok);
  });
}
function formatRow(r){
  const star = r.starred ? '*' : '';
  return `${r.series||''} ${r.subseries||''} ${r.index||''} - ${r.coating||''}${star}: HK$${r.price_hkd} /片${r.overseas ? ' (海外訂鏡)' : ''}〔${r.source_file} p.${r.page}，生效日 ${r.effective_date || '未知'}〕`;
}
function summarize(indexToken, matched){
  if(!indexToken) return '';
  const brand = BRAND_MAP[indexToken] || 'UNKNOWN BRAND';
  // group by coating label
  const byCoating = new Map();
  matched.filter(r=>r.index===indexToken).forEach(r=>{
    const key = r.coating;
    const arr = byCoating.get(key) || [];
    arr.push(r);
    byCoating.set(key, arr);
  });
  const rowsSumm = [...byCoating.entries()].map(([coating, list])=>{
    const prices = list.map(x=>x.price_hkd);
    prices.sort((a,b)=>a-b);
    const min = prices[0];
    const max = prices[prices.length-1];
    const starCount = list.filter(x=>x.starred).length;
    const starFlag = starCount ? ` *${starCount}`: '';
    return { coating, min, max, count: list.length, starFlag };
  }).sort((a,b)=>a.min-b.min);
  if(!rowsSumm.length) return '';
  const lines = rowsSumm.map(r=>{
    const range = r.min===r.max ? r.min : `${r.min}-${r.max}`;
    return `${r.coating.padEnd(12,' ')} HK$${range}${r.starFlag}`;
  });
  return `Summary for ${brand} index ${indexToken} (prices per piece)\n` + lines.join('\n');
}

function search(){
  if(!loaded){ statusEl.textContent='Data not yet loaded…'; return; }
  const q=questionEl.value;
  const tokens=tokenize(q);
  lastQuery=q;
  clearBtn.classList.toggle('dim', !q.trim());
  if(tokens.length===0){ resultEl.innerHTML='(Enter keywords to search)'; statusEl.textContent=`Loaded ${rows.length} records`; return; }
  // Determine which free-text tokens actually appear anywhere (excluding numeric/index & special filters)
  const universeText = rows.slice(0,4000).map(r=>[r.series,r.subseries,r.index,r.coating,r.source_file,r.effective_date].join(' ').toLowerCase()).join(' ');
  const effectiveTokens=[]; const skippedTokens=[];
  tokens.forEach(t=>{
    if(t==='海外'||t==='overseas'||t==='本地'||t==='local'||/^\d+(?:\.\d+)?$/.test(t)) { effectiveTokens.push(t); return; }
    if(universeText.includes(t)) effectiveTokens.push(t); else skippedTokens.push(t);
  });
  const usedTokens = effectiveTokens.length? effectiveTokens : tokens.filter(t=>/^\d+(?:\.\d+)?$/.test(t));
  const matched=rows.filter(r=>matchRow(r, usedTokens));
  let status = `Matched ${matched.length} / ${rows.length} records`;
  if(skippedTokens.length) status += ` (ignored: ${skippedTokens.join(', ')})`;
  statusEl.textContent = status;
  if(matched.length===0){ resultEl.textContent='No matching data'; summary.style.display='none'; return; }
  // try to detect first numeric token as index for summary
  const firstIndexTok = usedTokens.find(t=>/^\d+(?:\.\d+)?$/.test(t));
  const summaryHtml = summarize(firstIndexTok, matched);
  if(summaryHtml){
    summary.textContent = summaryHtml;
    summary.style.display='block';
  } else {
    summary.style.display='none';
  }
  const tokensLower=usedTokens.map(t=>t.toLowerCase());
  resultEl.innerHTML = matched.map(r=>highlight(formatRow(r), tokensLower)).join('\n');
}
questionEl.addEventListener('keydown', e => { if(e.key==='Enter'){ search(); } });
</script>
<footer>
  靜態搜尋：上傳新的價目後重新產生 <code>prices.json</code> 並覆蓋即可。 支援關鍵字分詞、指數 (1.6)、海外/本地 過濾。
</footer>
</body>
</html>