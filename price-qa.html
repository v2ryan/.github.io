<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Price Q&A</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; padding: 1rem; line-height: 1.4; }
  h1 { margin-top: 0; }
  #controls { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; }
  #question { flex: 1 1 420px; padding: .5rem; font-size: 1rem; }
  button { padding: .55rem .9rem; font-size: .95rem; cursor: pointer; }
  #status { font-size: .85rem; color: #555; margin-top: .5rem; }
  #result { white-space: pre-wrap; background: #f7f7f7; padding: .75rem; border-radius: 6px; border: 1px solid #e2e2e2; margin-top: 1rem; max-height: 55vh; overflow: auto; }
  .dim { opacity: .6; }
  footer { margin-top: 2rem; font-size: .75rem; color: #666; }
  mark { background: #ffec99; padding: 0 2px; }
</style>
</head>
<body>
<h1>Price Q&A</h1>
<div id="controls">
  <input id="question" placeholder="輸入關鍵字 (例: 1.6 NULUX 藍光 海外)" size="50" />
  <button id="searchBtn" onclick="search()">Search</button>
  <button id="clearBtn" onclick="clearQuery()" class="dim">Clear</button>
  <button id="configBtn" type="button" title="設定/編輯鏡片類型名稱" style="background:#eef;border:1px solid #ccd;">⚙</button>
  <label style="display:flex;align-items:center;gap:.35rem;font-size:.65rem;padding:.25rem .5rem;border:1px solid #ddd;border-radius:4px;">
    <input type="checkbox" id="summaryOnlyToggle" /> 只顯示摘要
  </label>
  <button id="multiIndexBtn" type="button" style="background:#efe;border:1px solid #bcb;">多 Index 摘要</button>
  <button id="exportCsvBtn" type="button" style="background:#ffe;border:1px solid #ddc;">匯出 CSV</button>
</div>
<div id="status">Loading data…</div>
<div id="summary" style="margin-top:.5rem;font-size:.9rem;color:#222;background:#eef6ff;padding:.6rem .75rem;border:1px solid #c3e1ff;border-radius:6px;display:none"></div>
<pre id="result">(No results yet)</pre>

<details id="headerDetect" style="margin-top:.75rem;background:#fafafa;border:1px solid #ddd;padding:.6rem .7rem;border-radius:6px;">
  <summary style="cursor:pointer;font-size:.75rem;font-weight:600;">貼上 PDF 標題列 (自動拆解成 coating 名稱)</summary>
  <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;">
    <textarea id="headerLineInput" rows="2" placeholder="例: UV CONTROL  FULL CONTROL  CLEAR  SENSITY2  SENSITY2 SHINE  POLARIZED" style="width:100%;font-family:monospace;font-size:.7rem;padding:.4rem;"></textarea>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <button type="button" id="parseHeaderBtn" style="background:#e0f3ff;border:1px solid #9bd;">解析並套用</button>
      <span id="headerParseMsg" style="font-size:.65rem;color:#555;"></span>
    </div>
  </div>
</details>
<div id="multiSummary" style="display:none;margin-top:1rem;overflow:auto;max-width:100%;"></div>

<dialog id="configDialog" style="max-width:520px;width:95%;border:1px solid #aac;background:#fff;padding:1rem;border-radius:10px;">
  <form method="dialog" style="margin:0;display:flex;flex-direction:column;gap:.75rem;">
    <h3 style="margin:.2rem 0 .2rem;font-size:1.05rem;">鏡片 coating 對應設定 (variant → 名稱)</h3>
    <p style="margin:0;font-size:.7rem;line-height:1.35;color:#444;">
      左列自動偵測的 <code>variant1..N</code> 可以在此改成實際名稱（例如 UV CONTROL / FULL CONTROL / CLEAR / SENSITY2 ...）。
      只儲存在本機瀏覽器（localStorage）。關閉視窗後自動重新整理結果。
    </p>
    <div id="mappingFields" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.55rem;"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;">
      <label style="font-size:.65rem;color:#333;display:flex;align-items:center;gap:.3rem;">
        <input type="checkbox" id="applyAllIndexes" checked /> 套用到所有折射率 (index)
      </label>
      <div style="display:flex;gap:.5rem;">
        <button type="button" id="resetMapping" style="background:#fee;border:1px solid #f99;">重置</button>
        <button value="cancel" style="background:#eee;">關閉</button>
      </div>
    </div>
  </form>
</dialog>

<script>
let rows = [];
let loaded = false;
let lastQuery = '';
const BRAND_MAP = { '1.6':'NULUX', '1.67':'NULUX' }; // 可自行調整
const DEFAULT_VARIANT_LABELS = ['UV CONTROL','FULL CONTROL','CLEAR','SENSITY2','SENSITY2 SHINE','POLARIZED'];
const STORAGE_KEY_MAPPING = 'priceQaVariantMappingV1';
let variantMapping = loadVariantMapping();

const questionEl = document.getElementById('question');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const searchBtn = document.getElementById('searchBtn');
const clearBtn = document.getElementById('clearBtn');
const configBtn = document.getElementById('configBtn');
const configDialog = document.getElementById('configDialog');
const mappingFields = document.getElementById('mappingFields');
const applyAllIndexesEl = document.getElementById('applyAllIndexes');
const resetMappingBtn = document.getElementById('resetMapping');
const summaryOnlyToggle = document.getElementById('summaryOnlyToggle');
const parseHeaderBtn = document.getElementById('parseHeaderBtn');
const headerLineInput = document.getElementById('headerLineInput');
const headerParseMsg = document.getElementById('headerParseMsg');
const multiIndexBtn = document.getElementById('multiIndexBtn');
const multiSummaryEl = document.getElementById('multiSummary');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const summaryEl = document.getElementById('summary');

// Load data
fetch('prices.json', { cache: 'no-store' })
  .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
  .then(d => { rows = Array.isArray(d) ? d : []; loaded = true; statusEl.textContent = `Loaded ${rows.length} records`; })
  .catch(err => { statusEl.textContent = 'Failed to load prices.json: ' + err.message; statusEl.style.color = '#b00020'; });

function norm(s){ return (s||'').toLowerCase().trim(); }
function tokenize(q){ return norm(q).split(/\s+/).filter(t => t); }
function clearQuery(){ questionEl.value=''; resultEl.textContent='(No results)'; statusEl.textContent = loaded ? `Loaded ${rows.length} records` : 'Not loaded'; clearBtn.classList.add('dim'); lastQuery=''; }
function highlight(line, tokens){ let out=line; tokens.forEach(t=>{ const re=new RegExp('(' + t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')','ig'); out = out.replace(re,'<mark>$1</mark>'); }); return out; }
function matchRow(row, tokens){
  const combined=[row.series,row.subseries,row.index,row.coating,row.source_file,row.effective_date].map(v=>norm(v)).join(' ');
  return tokens.every(tok=>{
    if(tok==='海外'||tok==='overseas') return !!row.overseas;
    if(tok==='本地'||tok==='local') return !row.overseas;
    if(/^\d+(?:\.\d+)?$/.test(tok)) return norm(row.index)===tok;
    return combined.includes(tok);
  });
}
function formatRow(r){
  const star = r.starred ? '*' : '';
  const mapped = mapVariantName(r.index, r.coating);
  return `${r.series||''} ${r.subseries||''} ${r.index||''} - ${mapped}${star}: HK$${r.price_hkd} /片${r.overseas ? ' (海外訂鏡)' : ''}〔${r.source_file} p.${r.page}，生效日 ${r.effective_date || '未知'}〕`;
}
function loadVariantMapping(){
  try { const raw = localStorage.getItem(STORAGE_KEY_MAPPING); if(!raw) return { '*': DEFAULT_VARIANT_LABELS.slice() }; const obj = JSON.parse(raw); if(!obj['*']) obj['*']=DEFAULT_VARIANT_LABELS.slice(); return obj; } catch(e){ return { '*': DEFAULT_VARIANT_LABELS.slice() }; }
}
function saveVariantMapping(){ localStorage.setItem(STORAGE_KEY_MAPPING, JSON.stringify(variantMapping)); }
function getLabelsForIndex(index){ return (variantMapping[index] && variantMapping[index].length)? variantMapping[index] : variantMapping['*']; }
function mapVariantName(index, coating){ const m = coating.match(/^variant(\d+)$/); if(!m) return coating; const labels = getLabelsForIndex(index); const idx = parseInt(m[1])-1; return labels[idx] || coating; }
function openConfig(){
  // 找出最大的 variant 數量
  const maxVar = Math.max(...rows.map(r=>{ const m=r.coating.match(/^variant(\d+)$/); return m? parseInt(m[1]):1; }), 6);
  mappingFields.innerHTML='';
  const labels = getLabelsForIndex('*');
  for(let i=1;i<=maxVar;i++){
    const wrap=document.createElement('label');
    wrap.style.display='flex';wrap.style.flexDirection='column';wrap.style.fontSize='.6rem';
    wrap.textContent=`variant${i}`;
    const input=document.createElement('input');
    input.style.padding='.35rem';input.style.fontSize='.75rem';
    input.value= labels[i-1] || `Coating ${i}`;
    input.dataset.variantIndex=String(i-1);
    wrap.appendChild(input);
    mappingFields.appendChild(wrap);
  }
  if(configDialog.showModal) configDialog.showModal(); else configDialog.style.display='block';
}
configBtn.addEventListener('click', openConfig);
resetMappingBtn.addEventListener('click', ()=>{ variantMapping={ '*': DEFAULT_VARIANT_LABELS.slice() }; saveVariantMapping(); search(); });
configDialog.addEventListener('close', ()=>{
  const inputs = mappingFields.querySelectorAll('input[data-variant-index]');
  const arr=[]; inputs.forEach(inp=>{ const i=parseInt(inp.dataset.variantIndex||'0'); arr[i]= inp.value.trim() || `Coating ${i+1}`; });
  if(applyAllIndexesEl.checked) variantMapping['*']=arr; else {
    const idxTok = (lastQuery.split(/\s+/).find(t=>/^\d+(?:\.\d+)?$/.test(t))) || '*';
    variantMapping[idxTok]=arr;
  }
  saveVariantMapping();
  search();
});
function summarize(indexToken, matched){
  if(!indexToken) return '';
  const brand = BRAND_MAP[indexToken] || 'UNKNOWN BRAND';
  const byCoating = new Map();
  matched.filter(r=>r.index===indexToken).forEach(r=>{
    const key = mapVariantName(r.index, r.coating);
    const arr = byCoating.get(key) || [];
    arr.push(r);
    byCoating.set(key, arr);
  });
  const rowsSumm = [...byCoating.entries()].map(([coating, list])=>{
    const prices = list.map(x=>x.price_hkd).sort((a,b)=>a-b);
    const min = prices[0];
    const max = prices[prices.length-1];
    const starCount = list.filter(x=>x.starred).length;
    const avg = (prices.reduce((a,b)=>a+b,0)/prices.length).toFixed(1);
    const med = (prices.length%2? prices[(prices.length-1)/2] : ((prices[prices.length/2-1]+prices[prices.length/2])/2).toFixed(1));
    return { coating, min, max, count: list.length, star: starCount, avg, med };
  }).sort((a,b)=>a.min-b.min);
  if(!rowsSumm.length) return '';
  const tableLines = rowsSumm.map(r=>{
    const range = r.min===r.max ? r.min : `${r.min}-${r.max}`;
    const starChunk = r.star? ` *${r.star}`: '';
    return `${r.coating.padEnd(14,' ')} ${String(range).padEnd(10,' ')} avg:${String(r.avg).padEnd(6,' ')} med:${String(r.med).padEnd(6,' ')} n=${r.count}${starChunk}`;
  });
  const header = `${brand} ${indexToken} 摘要 (每片)\nCoating         Range      Avg     Med     Count`;
  return header + "\n" + tableLines.join('\n');
}

function buildSummaryData(indexToken, matched){
  if(!indexToken) return [];
  const byCoating = new Map();
  matched.filter(r=>r.index===indexToken).forEach(r=>{
    const key = mapVariantName(r.index, r.coating);
    const arr = byCoating.get(key) || []; arr.push(r); byCoating.set(key, arr);
  });
  return [...byCoating.entries()].map(([coating,list])=>{
    const prices=list.map(x=>x.price_hkd).sort((a,b)=>a-b);
    const min=prices[0]; const max=prices[prices.length-1];
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
    const med = prices.length%2? prices[(prices.length-1)/2] : (prices[prices.length/2-1]+prices[prices.length/2])/2;
    const star = list.filter(x=>x.starred).length;
    return { index:indexToken, coating, min, max, avg, med, count:prices.length, star };
  }).sort((a,b)=>a.min-b.min);
}

function exportSummaryCsv(currentIndex, matched){
  const rows = buildSummaryData(currentIndex, matched);
  if(!rows.length){ alert('No summary rows'); return; }
  const header='index,coating,min,max,avg,median,count,starred';
  const lines = rows.map(r=>`${r.index},"${r.coating}",${r.min},${r.max},${r.avg.toFixed? r.avg.toFixed(2):r.avg},${r.med},${r.count},${r.star}`);
  const csv = [header,...lines].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`summary_${currentIndex||'all'}.csv`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}

function buildMultiIndexSummary(){
  const indices = [...new Set(rows.map(r=>r.index))].filter(x=>/^\d/.test(x)).sort((a,b)=>parseFloat(a)-parseFloat(b));
  if(indices.length<2){ multiSummaryEl.style.display='none'; multiSummaryEl.innerHTML=''; return; }
  const variantLabels = getLabelsForIndex('*');
  const matrix = variantLabels.map(label=>({ label, values:{} }));
  indices.forEach(idx=>{
    const subset = rows.filter(r=>r.index===idx);
    const map = new Map();
    subset.forEach(r=>{ const label = mapVariantName(r.index, r.coating); const arr = map.get(label) || []; arr.push(r.price_hkd); map.set(label, arr); });
    map.forEach((arr,label)=>{ arr.sort((a,b)=>a-b); const rowObj = matrix.find(m=>m.label===label); if(rowObj) rowObj.values[idx] = { min:arr[0], max:arr[arr.length-1] }; });
  });
  let html = '<table style="border-collapse:collapse;font-size:.7rem;min-width:520px;">';
  html += '<thead><tr><th style="border:1px solid #ccc;padding:4px 6px;text-align:left;">Coating</th>' + indices.map(i=>`<th style=\"border:1px solid #ccc;padding:4px 6px;\">${i}</th>`).join('') + '</tr></thead><tbody>';
  matrix.forEach(row=>{
    html+='<tr><td style="border:1px solid #ddd;padding:4px 6px;">'+row.label+'</td>';
    indices.forEach(i=>{ const cell=row.values[i]; const txt = cell? (cell.min===cell.max? cell.min : `${cell.min}-${cell.max}`) : ''; html+=`<td style=\"border:1px solid #ddd;padding:4px 6px;\">${txt}</td>`; });
    html+='</tr>';
  });
  html+='</tbody></table>';
  multiSummaryEl.innerHTML = html;
  multiSummaryEl.style.display='block';
}

multiIndexBtn.addEventListener('click', ()=>{ buildMultiIndexSummary(); });
exportCsvBtn.addEventListener('click', ()=>{
  const idxTok = (lastQuery.split(/\s+/).find(t=>/^\d+(?:\.\d+)?$/.test(t))) || prompt('輸入要匯出的 index (例如 1.6) 空白=使用第一個');
  const chosen = idxTok || (rows[0]? rows[0].index : '');
  const matched = chosen? rows.filter(r=>r.index===chosen) : rows;
  exportSummaryCsv(chosen, matched);
});
summaryOnlyToggle.addEventListener('change', ()=>{ resultEl.style.display = summaryOnlyToggle.checked ? 'none':'block'; });
parseHeaderBtn.addEventListener('click', ()=>{
  const raw = headerLineInput.value.trim();
  if(!raw){ headerParseMsg.textContent='空白'; return; }
  const tokens = raw.split(/[,|\t]+|\s{2,}/).map(t=>t.trim()).filter(Boolean);
  if(tokens.length<2){ headerParseMsg.textContent='辨識不到多個欄位 (需要至少 2 個)'; return; }
  variantMapping['*'] = tokens;
  saveVariantMapping();
  headerParseMsg.textContent = `已套用 ${tokens.length} 個名稱`; setTimeout(()=>headerParseMsg.textContent='',3000);
  search();
});

function search(){
  if(!loaded){ statusEl.textContent='Data not yet loaded…'; return; }
  const q=questionEl.value;
  const tokens=tokenize(q);
  lastQuery=q;
  clearBtn.classList.toggle('dim', !q.trim());
  if(tokens.length===0){ resultEl.innerHTML='(Enter keywords to search)'; statusEl.textContent=`Loaded ${rows.length} records`; return; }
  // Determine which free-text tokens actually appear anywhere (excluding numeric/index & special filters)
  const universeText = rows.slice(0,4000).map(r=>[r.series,r.subseries,r.index,r.coating,r.source_file,r.effective_date].join(' ').toLowerCase()).join(' ');
  const effectiveTokens=[]; const skippedTokens=[];
  tokens.forEach(t=>{
    if(t==='海外'||t==='overseas'||t==='本地'||t==='local'||/^\d+(?:\.\d+)?$/.test(t)) { effectiveTokens.push(t); return; }
    if(universeText.includes(t)) effectiveTokens.push(t); else skippedTokens.push(t);
  });
  const usedTokens = effectiveTokens.length? effectiveTokens : tokens.filter(t=>/^\d+(?:\.\d+)?$/.test(t));
  const matched=rows.filter(r=>matchRow(r, usedTokens));
  let status = `Matched ${matched.length} / ${rows.length} records`;
  if(skippedTokens.length) status += ` (ignored: ${skippedTokens.join(', ')})`;
  statusEl.textContent = status;
  if(matched.length===0){ resultEl.textContent='No matching data'; summaryEl.style.display='none'; return; }
  // try to detect first numeric token as index for summary
  const firstIndexTok = usedTokens.find(t=>/^\d+(?:\.\d+)?$/.test(t));
  const summaryHtml = summarize(firstIndexTok, matched);
  if(summaryHtml){
    summaryEl.textContent = summaryHtml;
    summaryEl.style.display='block';
  } else {
    summaryEl.style.display='none';
  }
  const tokensLower=usedTokens.map(t=>t.toLowerCase());
  resultEl.innerHTML = matched.map(r=>highlight(formatRow(r), tokensLower)).join('\n');
  if(summaryOnlyToggle.checked){ resultEl.style.display='none'; }
}
questionEl.addEventListener('keydown', e => { if(e.key==='Enter'){ search(); } });
</script>
<footer>
  靜態搜尋：上傳新的價目後重新產生 <code>prices.json</code> 並覆蓋即可。 支援關鍵字分詞、指數 (1.6)、海外/本地 過濾。
</footer>
</body>
</html>