<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reaction Challenge - Firebase</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --primary-color:#2ed573; --secondary-color:#ff4757; --bg-color:#f0f2f5; --text-color:#2f3542; --card-bg:#ffffff; --penalty-color:#ff6b81; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:var(--bg-color); color:var(--text-color); display:flex; flex-direction:column; align-items:center; min-height:100vh; margin:0; padding:20px 10px; box-sizing:border-box; user-select:none; }
        h1,h2,h3 { margin:.5em 0; text-align:center; }
        .main-container { display:flex; flex-direction:column; align-items:center; width:100%; max-width:480px; }
        .status-bar { margin-bottom:15px; font-size:1.3rem; font-weight:700; color:#57606f; height:35px; display:flex; align-items:center; justify-content:center; white-space:nowrap; }
        .grid-container { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; background:#dfe4ea; padding:15px; border-radius:16px; box-shadow:0 8px 16px rgba(0,0,0,.08); width:100%; max-width:360px; aspect-ratio:1/1; margin-bottom:20px; transition:background-color .2s; }
        .grid-container.penalty-flash { background:var(--penalty-color); animation:shake .4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {10%,90%{transform:translate3d(-1px,0,0);}20%,80%{transform:translate3d(2px,0,0);}30%,50%,70%{transform:translate3d(-4px,0,0);}40%,60%{transform:translate3d(4px,0,0);} }
        .cell { background:var(--card-bg); border-radius:12px; cursor:pointer; transition:transform .1s, background-color .15s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent; }
        .cell:active { transform:scale(.92); }
        .cell.active { background:var(--secondary-color); box-shadow:0 0 20px rgba(255,71,87,.7); border:2px solid #fff; }
        .controls { width:100%; display:flex; justify-content:center; margin-bottom:20px; }
        .btn { padding:12px 30px; font-size:1.1rem; font-weight:700; border:none; border-radius:30px; cursor:pointer; transition:.2s; box-shadow:0 4px 6px rgba(0,0,0,.1); }
        #start-btn { background:var(--primary-color); color:#fff; }
        #start-btn:hover:not(:disabled) { background:#26af61; transform:translateY(-2px); }
        #start-btn:disabled { background:#ccc; cursor:not-allowed; transform:none; box-shadow:none; }
        #screenshot-btn { background:#3742fa; color:#fff; margin-top:20px; font-size:.95rem; display:flex; align-items:center; gap:8px; justify-content:center; width:100%; max-width:300px; }
        #screenshot-btn:hover { background:#2f3542; }
        #capture-area { width:100%; box-sizing:border-box; padding:20px; background:var(--bg-color); border-radius:10px; }
        .results-container { background:var(--card-bg); padding:20px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.05); width:100%; box-sizing:border-box; margin-bottom:20px; }
        #current-result-board { display:none; }
        .result-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f2f6; font-feature-settings:"tnum"; }
        .result-item.excluded { color:#b2bec3; text-decoration:line-through; font-size:.9em; }
        .result-item.penalty-text { color:var(--secondary-color); font-weight:700; }
        .average-score-box { margin-top:15px; padding:15px; background:#f1f2f6; border-radius:10px; text-align:center; }
        .average-score-box strong { color:var(--secondary-color); font-size:1.5em; }
        .average-note { font-size:.8rem; color:#747d8c; margin-top:5px; }
        .leaderboard-list { list-style:none; padding:0; margin:0; }
        .leaderboard-item { display:flex; justify-content:space-between; align-items:center; padding:10px 5px; border-bottom:1px solid #eee; font-size:.9rem; }
        .rank-num { font-weight:700; width:30px; color:#747d8c; }
        .rank-1 .rank-num { color:#ffd32a; font-size:1.1em; }
        .rank-2 .rank-num { color:#d2d6de; font-size:1.05em; }
        .rank-3 .rank-num { color:#ff7f50; font-size:1.05em; }
        .rank-time { font-weight:700; color:var(--text-color); }
        .rank-date { font-size:.75rem; color:#a4b0be; }
        .footer-note { text-align:center; font-size:.8rem; color:#999; margin-top:10px; }
    </style>
</head>
<body>
<div class="main-container">
    <h1>âš¡ åæ‡‰åŠ›æŒ‘æˆ° âš¡</h1>
    <div class="status-bar" id="status-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
    <div class="grid-container" id="grid"></div>
    <div class="controls"><button id="start-btn" class="btn" onclick="startGame()">é–‹å§‹æ¸¬è©¦</button></div>
    <div id="capture-area">
        <div id="current-result-board" class="results-container">
            <h3>æœ¬æ¬¡æ¸¬è©¦çµæœ</h3>
            <div id="result-list"></div>
            <div class="average-score-box" id="average-score"></div>
        </div>
        <div id="leaderboard-board" class="results-container">
            <h3>ğŸ† Firebase TOP 10</h3>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
        </div>
        <div class="footer-note">Challenge your reaction speed! (Firebase)</div>
    </div>
    <button id="screenshot-btn" class="btn" style="display:none;" onclick="takeScreenshot()">ğŸ“¸ æˆªåœ–æˆç¸¾å–® (è¤‡è£½åˆ°å‰ªè²¼ç°¿)</button>
</div>
<script type="module">
    import { database, ref, push, set, onValue, query, orderByChild, limitToFirst } from './firebase-config.js';
    const gridContainer = document.getElementById('grid');
    const statusText = document.getElementById('status-text');
    const startBtn = document.getElementById('start-btn');
    const currentResultBoard = document.getElementById('current-result-board');
    const resultList = document.getElementById('result-list');
    const averageScoreDiv = document.getElementById('average-score');
    const leaderboardList = document.getElementById('leaderboard-list');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const captureArea = document.getElementById('capture-area');
    const TOTAL_ROUNDS = 7;
    let currentRound = 0, reactionTimes = [], startTime = 0, gamePhase = 'idle', activeCellIndex = -1, timer = null;
    function init(){ initGrid(); subscribeLeaderboard(); }
    function initGrid(){ gridContainer.innerHTML=''; for(let i=0;i<9;i++){ const cell=document.createElement('div'); cell.classList.add('cell'); cell.addEventListener('pointerdown',e=>{e.preventDefault(); handleCellClick(i);}); gridContainer.appendChild(cell);} }
    function startGame(){ currentRound=0; reactionTimes=[]; startBtn.disabled=true; startBtn.textContent='æ¸¬è©¦é€²è¡Œä¸­...'; currentResultBoard.style.display='none'; screenshotBtn.style.display='none'; document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active')); nextRound(); }
    function nextRound(){ if(currentRound>=TOTAL_ROUNDS){ endGame(); return; } currentRound++; statusText.innerHTML=`<span style="color:#747d8c">Round ${currentRound}/${TOTAL_ROUNDS}</span> - ç­‰å¾…äº®ç‡ˆ...`; gamePhase='waiting'; document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active')); const randomDelay=Math.floor(Math.random()*1700)+800; timer=setTimeout(activateRandomCell,randomDelay); }
    function activateRandomCell(){ if(gamePhase!=='waiting') return; const cells=document.querySelectorAll('.cell'); let randomIndex; do{ randomIndex=Math.floor(Math.random()*9);} while(randomIndex===activeCellIndex && Math.random()>0.5); activeCellIndex=randomIndex; cells[randomIndex].classList.add('active'); startTime=performance.now(); gamePhase='active'; statusText.innerHTML='<span style="color: var(--secondary-color)">ğŸ”¥ å¿«æŒ‰! ğŸ”¥</span>'; }
    function handleCellClick(index){ if(gamePhase==='waiting'){ triggerPenalty(); return;} if(gamePhase==='active' && index===activeCellIndex){ const rt=Math.round(performance.now()-startTime); recordSuccess(rt);} }
    function triggerPenalty(){ clearTimeout(timer); gamePhase='processing'; gridContainer.classList.add('penalty-flash'); setTimeout(()=>gridContainer.classList.remove('penalty-flash'),400); reactionTimes.push(1000); statusText.innerHTML='<span style="color: var(--secondary-color)">ğŸš« å·è·‘çŠ¯è¦! (+1000ms)</span>'; setTimeout(nextRound,1000); }
    function recordSuccess(time){ gamePhase='processing'; reactionTimes.push(time); document.querySelectorAll('.cell')[activeCellIndex].classList.remove('active'); statusText.textContent=`${time} ms`; setTimeout(nextRound,400); }
    function endGame(){ gamePhase='idle'; startBtn.disabled=false; startBtn.textContent='å†æ¬¡æŒ‘æˆ°'; statusText.innerHTML='ğŸ‰ æ¸¬è©¦å®Œæˆ!'; showCurrentResults(); saveScoreToFirebase(); screenshotBtn.style.display='flex'; currentResultBoard.scrollIntoView({behavior:'smooth', block:'start'}); }
    function calculateTrimmedScore(times){ if(times.length<3) return {avg:0,minIdx:-1,maxIdx:-1}; const minVal=Math.min(...times), maxVal=Math.max(...times); const minIdx=times.indexOf(minVal), maxIdx=times.indexOf(maxVal); const sorted=[...times].sort((a,b)=>a-b); const trimmed=sorted.slice(1,sorted.length-1); const total=trimmed.reduce((a,b)=>a+b,0); return {avg:Math.round(total/trimmed.length), minIdx, maxIdx}; }
    function showCurrentResults(){ currentResultBoard.style.display='block'; resultList.innerHTML=''; const {avg,minIdx,maxIdx}=calculateTrimmedScore(reactionTimes); reactionTimes.forEach((time,index)=>{ const item=document.createElement('div'); item.classList.add('result-item'); const isPenalty=time===1000; const isExcluded=index===minIdx||index===maxIdx; if(isExcluded) item.classList.add('excluded'); if(isPenalty) item.classList.add('penalty-text'); let roundText=`Round ${index+1}`; if(isExcluded){ if(index===minIdx) roundText+=' (æœ€å¿«)'; if(index===maxIdx) roundText+=' (æœ€æ…¢)'; } let timeText=`${time} ms`; if(isPenalty) timeText+=' (å·è·‘)'; item.innerHTML=`<span>${roundText}</span><span>${timeText}</span>`; resultList.appendChild(item); }); averageScoreDiv.innerHTML=`å¹³å‡åæ‡‰æ™‚é–“<br><strong>${calculateTrimmedScore(reactionTimes).avg} ms</strong><div class='average-note'>(å»é™¤æœ€å¿«èˆ‡æœ€æ…¢æˆç¸¾)</div>`; }
    function saveScoreToFirebase(){ const {avg}=calculateTrimmedScore(reactionTimes); if(!database) return; try{ const scoresRef=ref(database,'reactionScores'); const newRef=push(scoresRef); set(newRef,{avgTime:avg,timestamp:Date.now()}); }catch(e){ console.warn('Firebase save failed', e); } }
    function subscribeLeaderboard(){ if(!database){ renderLeaderboardLocalFallback(); return;} const scoresQuery=query(ref(database,'reactionScores'), orderByChild('avgTime'), limitToFirst(10)); onValue(scoresQuery,snap=>{ const arr=[]; snap.forEach(child=>{ arr.push(child.val()); }); arr.sort((a,b)=>a.avgTime-b.avgTime); renderLeaderboard(arr); }); }
    function renderLeaderboard(data){ leaderboardList.innerHTML=''; if(!data||data.length===0){ leaderboardList.innerHTML='<li style="text-align:center; padding:10px; color:#999;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°!</li>'; return;} data.forEach((score,index)=>{ const li=document.createElement('li'); li.className=`leaderboard-item rank-${index+1}`; li.innerHTML=`<div style='display:flex;align-items:center;'><span class='rank-num'>${index+1}.</span><span class='rank-time'>${score.avgTime} ms</span></div><span class='rank-date'>${formatDateTime(score.timestamp)}</span>`; leaderboardList.appendChild(li); }); }
    function renderLeaderboardLocalFallback(){ leaderboardList.innerHTML='<li style="text-align:center; padding:10px; color:#999;">Firebaseæœªå•Ÿå‹•</li>'; }
    function formatDateTime(ts){ const d=new Date(ts); return d.toLocaleString('zh-TW',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); }
    // Screenshot
    async function takeScreenshot(){ const original=screenshotBtn.innerHTML; screenshotBtn.innerHTML='â³ è™•ç†ä¸­...'; screenshotBtn.disabled=true; try{ const canvas=await html2canvas(captureArea,{scale:2, backgroundColor:'#f0f2f5', useCORS:true, width:captureArea.scrollWidth, height:captureArea.scrollHeight}); canvas.toBlob(async blob=>{ if(!blob) throw new Error('Canvas Error'); if(navigator.clipboard && navigator.clipboard.write){ try{ const item=new ClipboardItem({'image/png':blob}); await navigator.clipboard.write([item]); screenshotBtn.innerHTML='âœ… å·²è¤‡è£½!'; }catch(err){ fallbackDownload(canvas); } } else { fallbackDownload(canvas); } setTimeout(()=>{ screenshotBtn.innerHTML=original; screenshotBtn.disabled=false; },3000); },'image/png'); }catch(err){ console.error('Screenshot failed:',err); screenshotBtn.innerHTML='âŒ å¤±æ•—'; screenshotBtn.disabled=false; } }
    function fallbackDownload(canvas){ const link=document.createElement('a'); link.download=`åæ‡‰åŠ›æˆç¸¾_${Date.now()}.png`; link.href=canvas.toDataURL('image/png'); link.click(); screenshotBtn.innerHTML='âœ… å·²ä¸‹è¼‰åœ–ç‰‡'; }
    init();
</script>
</body>
</html>
