<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Top LLM &amp; AI GitHub Stars (Weekly)</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-base: #070b16;
        --bg-panel: rgba(15, 23, 42, 0.86);
        --accent: #38bdf8;
        --accent-strong: #22d3ee;
        --text: #e2e8f0;
        --text-soft: rgba(226, 232, 240, 0.75);
        --border: rgba(148, 163, 184, 0.28);
        font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
        padding: clamp(20px, 5vw, 48px);
        background:
          radial-gradient(circle at 12% 18%, rgba(56, 189, 248, 0.22), transparent 60%),
          radial-gradient(circle at 88% 12%, rgba(129, 140, 248, 0.16), transparent 62%),
          linear-gradient(140deg, #020617 0%, #0f172a 60%, #1e293b 100%);
        color: var(--text);
      }

      main {
        width: min(920px, 100%);
        background: var(--bg-panel);
        border-radius: 28px;
        border: 1px solid var(--border);
        box-shadow: 0 28px 60px rgba(2, 6, 23, 0.45);
        padding: clamp(24px, 4vw, 44px);
        backdrop-filter: blur(18px);
        position: relative;
      }

      .filters {
        display:flex; flex-wrap:wrap; gap:12px; margin: 8px 0 28px 0; align-items:flex-end;
      }
      .filters .field { display:flex; flex-direction:column; gap:6px; }
      .filters label { font-size:.7rem; letter-spacing:.08em; text-transform:uppercase; opacity:.7; }
      .filters input, .filters select { background:rgba(15,23,42,.7); color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:8px; font:inherit; }
      .filters button.action { padding:9px 16px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
      .filters button.secondary { padding:9px 14px; border:1px solid var(--border); background:rgba(15,23,42,.5); color:var(--text-soft); border-radius:8px; cursor:pointer; }
      .filters button.action:hover { background:var(--accent-strong); }
      .filters button.secondary:hover { color:var(--text); }
  .filters .inline-row { display:flex; align-items:center; gap:8px; }
  mark.match { background:rgba(250,204,21,.25); color:var(--accent-strong); padding:0 2px; border-radius:3px; }

      header { display: flex; flex-direction: column; gap: 12px; margin-bottom: clamp(24px, 4vw, 36px); }

      /* top bar */
      .top-bar {
        position: absolute; top: clamp(16px, 3vw, 24px); right: clamp(16px, 3vw, 24px);
        display: flex; gap: 8px; justify-content: flex-end;
      }
      .chip-btn {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 8px 14px; border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.7);
        color: var(--text); cursor: pointer; font-size: 0.85rem; font-weight: 600;
        transition: border-color .18s ease, background .18s ease, color .18s ease;
      }
      .chip-btn:hover, .chip-btn:focus-visible { border-color: rgba(56, 189, 248, .6); color: var(--accent-strong); outline: none; }
      .chip-btn[data-kind="lang"] span { opacity: .6; transition: opacity .18s ease; }
      .chip-btn[data-kind="lang"] span[data-active="true"] { opacity: 1; }
      .chip-btn[data-kind="api"]{ font-variant: all-small-caps; letter-spacing: .04em; }

      .breadcrumb{ font-size:.85rem;color:var(--text-soft);display:inline-flex;gap:8px;align-items:center; }
      .breadcrumb a{ color:var(--accent); text-decoration:none; font-weight:600; }
      .breadcrumb a:hover{ text-decoration:underline; }

      h1{ margin:0; font-size:clamp(2rem,4.8vw,2.6rem); font-weight:700; }
      .lead{ margin:0; font-size:1rem; color:var(--text-soft); line-height:1.6; max-width:680px; }

      .snapshot-meta{ display:flex; flex-wrap:wrap; gap:12px; margin:clamp(16px,3vw,24px) 0; font-size:.86rem; color:rgba(148,163,184,.85); }
      .snapshot-meta span{
        display:inline-flex; align-items:center; gap:6px; background:rgba(15,23,42,.68);
        border-radius:999px; padding:6px 12px; border:1px solid rgba(148,163,184,.24);
      }

      table{ width:100%; border-collapse:collapse; background:rgba(15,23,42,.7); border-radius:22px; overflow:hidden; border:1px solid rgba(148,163,184,.26); }
      thead{ background:rgba(15,23,42,.9); }
      th,td{ padding:clamp(14px,2.8vw,18px); text-align:left; border-bottom:1px solid rgba(148,163,184,.18); }
      th{ font-size:.78rem; letter-spacing:.08em; text-transform:uppercase; color:rgba(148,163,184,.8); }
      tbody tr:last-child td{ border-bottom:none; }
      tbody tr:hover{ background:rgba(30,64,175,.18); }
  tbody tr{ transition: background .18s ease, transform .18s ease, box-shadow .25s ease; }
  tbody tr:hover{ transform:translateY(-2px); box-shadow:0 6px 18px -6px rgba(0,0,0,.5); }
  tbody td{ vertical-align:top; }

  /* Modern card feel inside table */
  tbody tr{ backdrop-filter:blur(6px); }
  .repo a{ font-size:1rem; letter-spacing:.3px; }
  .repo .tags{ margin-top:2px; }
  .stars-badge{ display:inline-flex; align-items:center; gap:4px; background:linear-gradient(135deg,#0f172a,#1e293b); padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:600; color:var(--accent); border:1px solid rgba(56,189,248,.35); }
  .stars-badge svg{ width:14px; height:14px; }

  /* Translation toggle chip icon state */
  .chip-btn[data-active="true"]{ border-color:rgba(56,189,248,.7); color:var(--accent-strong); }

      .repo{ display:flex; flex-direction:column; gap:6px; }
      .repo a{ color:var(--accent); font-weight:600; text-decoration:none; }
      .repo a:hover{ text-decoration:underline; }

      .tags{ display:inline-flex; flex-wrap:wrap; gap:6px; font-size:.75rem; color:rgba(148,163,184,.85); }
      .tag-chip{
        display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px;
        background:rgba(56,189,248,.14); border:1px solid rgba(56,189,248,.3); color:var(--accent);
      }

      .loading-state{ display:flex; align-items:center; justify-content:center; gap:12px; padding:28px 18px; color:rgba(148,163,184,.8); font-size:.95rem; }
      .loading-state .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(148,163,184,.28); border-top-color:var(--accent); animation:spin 1s linear infinite; }
      @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

      .footnote{ margin-top:clamp(22px,4vw,32px); font-size:.85rem; color:rgba(148,163,184,.85); line-height:1.6; }

      @media (max-width: 720px){
        main{ padding-top:clamp(60px,12vw,72px); }
        table, thead, tbody, th, td, tr{ display:block; }
        thead{ display:none; }
        tbody tr{ border-bottom:1px solid rgba(148,163,184,.18); padding:18px 0; }
        tbody tr:last-child{ border-bottom:none; }
        td{ border:none; padding:6px 0; }
        td::before{
          content:attr(data-label); display:block; font-size:.75rem; text-transform:uppercase;
          color:rgba(148,163,184,.72); margin-bottom:4px; letter-spacing:.08em;
        }
        .repo{ gap:4px; }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="top-bar">
        <button type="button" class="chip-btn" data-kind="lang" data-lang-toggle aria-label="Switch language">
          <span data-lang-code="en" data-active="true">EN</span> / <span data-lang-code="zh-HK">繁</span>
        </button>
        <button type="button" class="chip-btn" data-kind="api" id="tokenBtn" title="Set GitHub API Token">API</button>
        <button type="button" class="chip-btn" id="translateDynBtn" title="Toggle dynamic description translation (試驗)">翻譯</button>
      </div>
      <div class="filters" aria-label="Search & filters">
        <div class="field" style="flex:2 1 180px;">
          <label for="topicInput">Topic / Keyword</label>
          <input id="topicInput" type="text" placeholder="e.g. llm, ai, agent, python" />
        </div>
        <div class="field">
          <label for="startDate">Start Date</label>
          <input id="startDate" type="date" />
        </div>
        <div class="field">
          <label for="endDate">End Date</label>
          <input id="endDate" type="date" />
        </div>
        <div class="field" style="width:90px;">
          <label for="minStars">Min Stars</label>
          <input id="minStars" type="number" min="0" value="1" />
        </div>
        <div class="field" style="width:110px;">
          <label for="maxRowsSel">Max Rows</label>
          <select id="maxRowsSel">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
        <div class="field" style="flex:0 0 auto; gap:8px;">
          <button id="searchBtn" class="action">Search</button>
          <button id="resetBtn" class="secondary" title="Reset filters">Reset</button>
          <div class="inline-row" style="margin-top:4px;">
            <input type="checkbox" id="strictMatch" />
            <label for="strictMatch" style="font-size:.65rem; letter-spacing:.08em; opacity:.65; cursor:pointer;">Name+Desc only</label>
          </div>
        </div>
      </div>

      <header>
        <nav class="breadcrumb" aria-label="Breadcrumb">
          <a href="index.html" data-i18n="breadcrumbHome">← Back to Idea Hub</a>
          <span data-i18n="breadcrumbCurrent">Weekly snapshot</span>
        </nav>
        <h1 data-i18n="heroTitle">Top LLM &amp; AI GitHub Stars</h1>
        <p class="lead" data-i18n="heroLead">
          A curated snapshot of the fastest-growing AI and LLM repositories on GitHub this week. Use it to catch up on
          what the community is excited about, evaluate emerging tooling, or find inspiration for your own experiments.
        </p>
        <div class="snapshot-meta" aria-live="polite">
          <span data-week-range>Rolling 7-day window</span>
          <span data-i18n="metaSource">Source: GitHub Search API</span>
          <span data-last-updated>Last refreshed: —</span>
        </div>
      </header>

      <table role="table">
        <thead>
          <tr>
            <th scope="col" data-i18n="thRepository">Repository</th>
            <th scope="col" data-i18n="thHighlights">Highlights</th>
            <th scope="col" data-i18n="thStars">Stars (since launch)</th>
          </tr>
        </thead>
        <tbody data-results>
          <tr>
            <td colspan="3">
              <div class="loading-state" role="status">
                <span class="spinner" aria-hidden="true"></span>
                <span data-i18n="loading">Fetching live repositories…</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <p class="footnote" data-i18n="footnote">
        Data refreshes automatically on page load using the public GitHub Search API with a rolling 7-day window. Star
        counts reflect each repository's total stars since creation during that window and are recalculated daily. If the
        API rate limit is reached, try again in a few minutes or supply a personal access token in the query string with
        <code>?token=&lt;your-token&gt;</code>.
      </p>

      <noscript>
        <p class="footnote">Enable JavaScript to load the latest weekly LLM and AI repositories from GitHub.</p>
      </noscript>
    </main>

<script>
  /* ===== i18n strings ===== */
  const LOCALE_STORAGE_KEY = 'ideaHubLocale';
  const DEFAULT_LOCALE = 'en';
  const SUPPORTED_LOCALES = ['en', 'zh-HK'];
  const localeFallbacks = { en: 'en', 'zh-HK': 'zh-Hant-HK' };

  const translations = {
    en: {
      pageTitle: 'Top LLM & AI GitHub Stars (Weekly)',
      toggleAria: 'Switch to Traditional Chinese',
      breadcrumbHome: '← Back to Idea Hub',
      breadcrumbCurrent: 'Weekly snapshot',
      heroTitle: 'Top LLM & AI GitHub Stars',
      heroLead:
        'A curated snapshot of the fastest-growing AI and LLM repositories on GitHub this week. Use it to catch up on what the community is excited about, evaluate emerging tooling, or find inspiration for your own experiments.',
      metaSource: 'Source: GitHub Search API',
      metaUpdatedPrefix: 'Last refreshed: ',
      thRepository: 'Repository',
      thHighlights: 'Highlights',
      thStars: 'Stars (since launch)',
      loading: 'Fetching live repositories…',
      noResults: 'No repositories matched the filters this week. Check back soon!',
      genericError: 'Something went wrong. Please try again later.',
      noDescription: 'No description provided.',
      footnote:
        "Data refreshes automatically on page load using the public GitHub Search API with a rolling 7-day window. Star counts reflect each repository's total stars since creation during that window and are recalculated daily. If the API rate limit is reached, try again in a few minutes or supply a personal access token in the query string with <code>?token=&lt;your-token&gt;</code>.",
    },
    'zh-HK': {
      pageTitle: '每週 LLM 與 AI GitHub 星標排行榜',
      toggleAria: '切換至英文',
      breadcrumbHome: '← 返回 Idea Hub',
      breadcrumbCurrent: '每週快照',
      heroTitle: '每週 LLM 與 AI GitHub 星標排行榜',
      heroLead:
        '每週整理 GitHub 上成長最快的 AI 與 LLM 儲存庫，用來追蹤社群焦點、評估新工具，或為你的專案找靈感。',
      metaSource: '資料來源：GitHub Search API',
      metaUpdatedPrefix: '最後更新：',
      thRepository: '儲存庫',
      thHighlights: '重點',
      thStars: '星標（累計）',
      loading: '正在擷取最新儲存庫…',
      noResults: '本週沒有符合條件的儲存庫，稍後再來看看！',
      genericError: '載入時發生問題，請稍後再試。',
      noDescription: '沒有提供描述。',
      footnote:
        '重新整理頁面時會透過 GitHub Search API 自動更新，採用滾動 7 日視窗。星標數為儲存庫在該時段的累計總數，每日重新計算。若遇到 API 限制，可稍後再試，或於網址加上 <code>?token=&lt;your-token&gt;</code> 使用個人存取權杖。',
    },
  };

  let keywords = ['llm', 'language model', 'agent', 'agents', 'langchain', 'rag', 'vector', 'transformer', 'ai'];
  let maxRows = 5; // user adjustable

  const langToggle = document.querySelector('[data-lang-toggle]');
  const tokenBtn   = document.getElementById('tokenBtn');
  const resultsBody = document.querySelector('[data-results]');
  const weekRangeLabel = document.querySelector('[data-week-range]');
  const lastUpdatedLabel = document.querySelector('[data-last-updated]');

  let currentLocale = DEFAULT_LOCALE;
  let cachedResults = [];
  let dataLoaded = false;
  let translateDynamic = false; // experimental zh-HK toggle

  /* ===== Token helpers ===== */
  const TOKEN_KEYS = ['GITHUB_PAT_SESSION', 'GITHUB_PAT_LOCAL'];

  // 捕捉 ?token=...（存 sessionStorage，再清 URL）
  (function captureTokenFromURL(){
    const params = new URLSearchParams(location.search);
    const t = params.get('token');
    if (t) {
      try { sessionStorage.setItem(TOKEN_KEYS[0], t.trim()); } catch {}
      const clean = location.pathname + location.hash;
      history.replaceState({}, '', clean);
    }
  })();

  function getAuthToken(){
    return sessionStorage.getItem(TOKEN_KEYS[0]) || localStorage.getItem(TOKEN_KEYS[1]) || null;
  }
  function setAuthTokenLocal(t){
    if (t) localStorage.setItem(TOKEN_KEYS[1], t.trim());
    else   localStorage.removeItem(TOKEN_KEYS[1]);
  }

  async function validateToken(){
    const token = getAuthToken();
    if (!token) return { ok: false, status: 0, message: 'no token' };

    try{
      const res = await fetch('https://api.github.com/rate_limit', {
        headers: {
          Accept: 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
          Authorization: `Bearer ${token}`,
        }
      });
      const body = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, message: body.message || 'OK' };
    }catch(e){
      return { ok: false, status: -1, message: String(e) };
    }
  }

  /* ===== i18n render ===== */
  function getStoredLocale(){
    const stored = localStorage.getItem(LOCALE_STORAGE_KEY);
    return SUPPORTED_LOCALES.includes(stored) ? stored : DEFAULT_LOCALE;
  }
  function persistLocale(locale){ localStorage.setItem(LOCALE_STORAGE_KEY, locale); }
  function applyLocaleToDocument(locale){ document.documentElement.lang = localeFallbacks[locale] || 'en'; }
  function updateToggleVisual(locale){
    langToggle?.setAttribute('aria-label', translations[locale].toggleAria);
    langToggle?.querySelectorAll('span').forEach((span) => {
      span.dataset.active = span.dataset.langCode === locale ? 'true' : 'false';
    });
  }
  function renderStaticCopy(){
    Object.entries(translations[currentLocale]).forEach(([key, value]) => {
      document.querySelectorAll(`[data-i18n="${key}"]`).forEach((node) => {
        if (key === 'footnote') node.innerHTML = value; else node.textContent = value;
      });
    });
  }
  function formatDate(date, options = {}){
    return new Intl.DateTimeFormat(localeFallbacks[currentLocale] || 'en',
      { day:'numeric', month:'short', year:'numeric', ...options }).format(date);
  }
  function formatCompact(n){
    return new Intl.NumberFormat(localeFallbacks[currentLocale] || 'en',
      { notation:'compact', maximumFractionDigits:1 }).format(n);
  }
  function formatTag(label){
    return label.replace(/[-_]/g,' ').replace(/\b\w/g, m => m.toUpperCase());
  }
  function renderMetaDates(){
    const now = new Date();
    const since = new Date(now); since.setDate(since.getDate() - 7);
    if (weekRangeLabel){
      const from = formatDate(since, { day:'numeric', month:'short' });
      const to   = formatDate(now,   { day:'numeric', month:'short', year:'numeric' });
      weekRangeLabel.textContent = `${from} – ${to}`;
    }
    if (lastUpdatedLabel){
      lastUpdatedLabel.textContent = `${translations[currentLocale].metaUpdatedPrefix}${formatDate(new Date(), { day:'numeric', month:'short', year:'numeric' })}`;
    }
  }

  /* ===== UI states ===== */
  function showLoading(){
    resultsBody.innerHTML = `
      <tr><td colspan="3">
        <div class="loading-state" role="status">
          <span class="spinner" aria-hidden="true"></span>
          <span>${translations[currentLocale].loading}</span>
        </div>
      </td></tr>`;
  }
  function showErrorLine(text){
    resultsBody.innerHTML = `
      <tr><td colspan="3">
        <div class="loading-state"><span aria-hidden="true">⚠️</span><span>${text}</span></div>
      </td></tr>`;
  }
  function showError(messageKey){
    const msg = (messageKey === 'noResults') ? translations[currentLocale].noResults : translations[currentLocale].genericError;
    showErrorLine(msg);
  }

  /* ===== GitHub search ===== */
  function repoIsRelevant(repo){
    const haystack = [repo.name, repo.full_name, repo.description || '', ...(repo.topics || [])]
      .join(' ').toLowerCase();
    return keywords.some(k => haystack.includes(k));
  }

  function createRow(repo){
    const tr = document.createElement('tr');

    const repoCell = document.createElement('td');
    repoCell.dataset.label = translations[currentLocale].thRepository;
    // highlight term if applicable
    const term = (document.getElementById('topicInput')?.value || '').trim();
    const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const nameDisplay = term ? repo.full_name.replace(new RegExp(safeTerm,'ig'), m => `<mark class="match">${m}</mark>`) : repo.full_name;
    repoCell.innerHTML = `
      <div class="repo">
        <a href="${repo.html_url}" target="_blank" rel="noopener">${nameDisplay}</a>
        <div class="tags"></div>
      </div>`;
    const tags = repoCell.querySelector('.tags');
    const tagSet = new Set();
    (repo.topics || []).forEach(t => { if (tagSet.size < 3) tagSet.add(formatTag(t)); });
    if (!tagSet.size){
      const fallback = repo.language ? [repo.language] : [];
      [...fallback, 'AI', 'LLM'].forEach(t => { if (tagSet.size < 3) tagSet.add(formatTag(t)); });
    }
    tagSet.forEach(t => { const s = document.createElement('span'); s.className='tag-chip'; s.textContent=t; tags.appendChild(s); });

    const hi = document.createElement('td');
    hi.dataset.label = translations[currentLocale].thHighlights;
    hi.textContent = repo.description ? repo.description.trim() : translations[currentLocale].noDescription;

  const stars = document.createElement('td');
  stars.dataset.label = translations[currentLocale].thStars;
  stars.innerHTML = `<span class="stars-badge" title="Total stars">${formatCompact(repo.stargazers_count)}★</span>`;

    tr.append(repoCell, hi, stars);
    return tr;
  }

  /* ===== Dynamic zh-HK translation (simple dictionary based, non-AI) ===== */
  const hkWordMap = {
    'transformer':'Transformer 模型', 'based':'基於', 'language':'語言', 'model':'模型', 'agent':'代理', 'agents':'代理',
    'multi-modal':'多模態', 'universal':'通用', 'rust':'Rust', 'python':'Python', 'linear algebra':'線性代數', 'written':'編寫',
    'completely':'完全', 'real time':'即時', 'feed-forward':'前饋', 'metric':'度量', 'reconstruction':'重建'
  };
  function hkReplacePhrase(text){
    if(!text) return text;
    let out = text;
    // phrase replacements first
    Object.entries(hkWordMap).forEach(([k,v]) => {
      const re = new RegExp(`\\b${k.replace(/[-/\\]/g,'\\$&')}\\b`,'gi');
      out = out.replace(re, (m)=>v);
    });
    return out;
  }
  function applyDynamicTranslation(){
    if (currentLocale !== 'zh-HK' || !translateDynamic) return;
    document.querySelectorAll('[data-results] tr td:nth-child(2)').forEach(td => {
      if(!td.dataset.orig){ td.dataset.orig = td.textContent; }
      td.textContent = hkReplacePhrase(td.dataset.orig);
    });
  }

  async function fetchQuery(query, {useAuth=true} = {}){
    const params = new URLSearchParams({ q: query, sort: 'stars', order: 'desc', per_page: '20' });
    const headers = {
      Accept: 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28',
    };
    const token = getAuthToken();
    if (useAuth && token) headers.Authorization = `Bearer ${token}`;

    const res = await fetch(`https://api.github.com/search/repositories?${params}`, { headers });
    let body = null;
    try { body = await res.json(); } catch {}

    if (!res.ok){
      const message = (body && (body.message || JSON.stringify(body))) || res.statusText || 'Unknown error';
      const err = new Error(`GitHub API error ${res.status}: ${message}`);
      err.status = res.status; err.payload = body;
      throw err;
    }
    return (body && body.items) || [];
  }

  let lastApiErrorText = '';

  function getFilterValues(){
    const topic = (document.getElementById('topicInput')?.value || '').trim();
    const start = (document.getElementById('startDate')?.value || '').trim();
    const end = (document.getElementById('endDate')?.value || '').trim();
    const minStarsVal = parseInt(document.getElementById('minStars')?.value || '1', 10) || 0;
    const maxRowsSel = parseInt(document.getElementById('maxRowsSel')?.value || '5', 10) || 5;
    return { topic, start, end, minStarsVal, maxRowsSel };
  }

  function normalizeDateInput(value){
    if(!value) return null; // expect yyyy-mm-dd
    return /^\d{4}-\d{2}-\d{2}$/.test(value) ? value : null;
  }

  async function loadWeeklyStars(topicOverride = null){
    const { topic, start, end, minStarsVal, maxRowsSel } = getFilterValues();
    maxRows = maxRowsSel;
    const minStars = minStarsVal < 0 ? 0 : minStarsVal;

    // Determine date window (default: last 30 days)
    const today = new Date();
    const endDate = normalizeDateInput(end) || today.toISOString().slice(0,10);
    let startDate = normalizeDateInput(start);
    if(!startDate){
      const tmp = new Date(endDate + 'T00:00:00Z');
      tmp.setDate(tmp.getDate() - 30);
      startDate = tmp.toISOString().slice(0,10);
    }
    // Guard for reversed dates
    if (startDate > endDate){
      const t = startDate; startDate = endDate; /* swap */ startDate = t;
    }

    const chosenTopic = topicOverride !== null ? topicOverride : topic;
    const results = new Map();
    let searchKeywords = chosenTopic ? [chosenTopic] : keywords;
    // Use explicit range for created
    // Build queries: topic created:startDate..endDate stars:>=minStars
    let queries = searchKeywords.map(k => {
      let parts = [];
      if(k) parts.push(k);
      parts.push(`created:${startDate}..${endDate}`);
      if (minStars > 0) parts.push(`stars:>=${minStars}`);
      parts.push('in:name,description,readme');
      return parts.join(' ');
    });

    results.clear();
    for (const q of queries){
      try{
        const repos = await fetchQuery(q, {useAuth:true});
        repos.forEach(r => { if (!results.has(r.id)) results.set(r.id, r); });
      }catch(eAuth){
        console.warn('Auth search failed:', eAuth);
        lastApiErrorText = eAuth.message || String(eAuth);
        try{
          const repos = await fetchQuery(q, {useAuth:false});
          repos.forEach(r => { if (!results.has(r.id)) results.set(r.id, r); });
        }catch(eAnon){
          console.warn('Anon search also failed:', eAnon);
          lastApiErrorText = eAnon.message || String(eAnon);
        }
      }
    }

    let arr = Array.from(results.values())
      .sort((a,b) => b.stargazers_count - a.stargazers_count);

    // strict client-side filter if requested
    const strict = document.getElementById('strictMatch')?.checked;
    if (strict && chosenTopic){
      const termLower = chosenTopic.toLowerCase();
      arr = arr.filter(r => (r.name && r.name.toLowerCase().includes(termLower)) || (r.description && r.description.toLowerCase().includes(termLower)) || (Array.isArray(r.topics) && r.topics.some(t => t.toLowerCase().includes(termLower))));
    }

    if (arr.length){
      cachedResults = arr.slice(0, maxRows);
    } else {
      cachedResults = [];
    }

    dataLoaded = true;
    if (!cachedResults.length){
      let reason = 'No repositories for this filter.';
      if (lastApiErrorText) reason += ` API: ${lastApiErrorText}`;
      showErrorLine(reason + ' Try broadening the topic, widening the date range, or lowering min stars.');
      return; }

    resultsBody.innerHTML = '';
    cachedResults.forEach(r => resultsBody.appendChild(createRow(r)));
    applyDynamicTranslation();
      applyDynamicTranslation();
  }

  /* ===== init & events ===== */
  function setLocale(locale, { rerenderOnly=false }={}){
    currentLocale = SUPPORTED_LOCALES.includes(locale) ? locale : DEFAULT_LOCALE;
    persistLocale(currentLocale);
    applyLocaleToDocument(currentLocale);
    updateToggleVisual(currentLocale);
    renderStaticCopy();
    document.title = translations[currentLocale].pageTitle;
    renderMetaDates();
    if (rerenderOnly){
      if (cachedResults.length){
        resultsBody.innerHTML = '';
        cachedResults.forEach(r => resultsBody.appendChild(createRow(r)));
      } else {
        showLoading();
      }
    }
  }

  async function init(){
    currentLocale = getStoredLocale();
    setLocale(currentLocale);
    showLoading();

    // 顯示 token 狀態（可自行用 console 查看）
    const v = await validateToken();
    if (!v.ok && v.status) {
      console.warn('Token invalid:', v.status, v.message);
    }

  await loadWeeklyStars();
    renderMetaDates();

    // Add topic search event
    const topicInput = document.getElementById('topicInput');
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
  const translateDynBtn = document.getElementById('translateDynBtn');
  if (searchBtn) searchBtn.addEventListener('click', async () => { showLoading(); await loadWeeklyStars(); });
    if (topicInput) topicInput.addEventListener('keydown', async e => { if(e.key==='Enter'){ showLoading(); await loadWeeklyStars(); }});
  const strict = document.getElementById('strictMatch');
  if (strict) strict.addEventListener('change', async () => { showLoading(); await loadWeeklyStars(); });
    if (resetBtn) resetBtn.addEventListener('click', async () => {
      (document.getElementById('topicInput')||{}).value='';
      (document.getElementById('startDate')||{}).value='';
      (document.getElementById('endDate')||{}).value='';
      (document.getElementById('minStars')||{}).value='1';
      (document.getElementById('maxRowsSel')||{}).value='5';
      showLoading(); await loadWeeklyStars();
    });
    if (translateDynBtn){
      translateDynBtn.addEventListener('click', () => {
        translateDynamic = !translateDynamic;
        translateDynBtn.dataset.active = translateDynamic ? 'true' : 'false';
        if (translateDynamic) applyDynamicTranslation();
        else {
          // restore originals
            document.querySelectorAll('[data-results] tr td:nth-child(2)').forEach(td => {
              if(td.dataset.orig) td.textContent = td.dataset.orig;
            });
        }
      });
    }
  }

  langToggle?.addEventListener('click', () => {
    const next = currentLocale === 'en' ? 'zh-HK' : 'en';
    setLocale(next, { rerenderOnly: true });
  });

  tokenBtn?.addEventListener('click', async () => {
    const existing = getAuthToken() || '';
    const t = prompt('Paste your GitHub token (stored locally). Leave blank to remove.\n本機儲存，不會上傳到伺服器。', existing);
    if (t === null) return;
    const trimmed = t.trim();
    if (trimmed){
      setAuthTokenLocal(trimmed);
      alert('Saved locally. 將使用較高 API 配額。');
    } else {
      setAuthTokenLocal('');
      try { sessionStorage.removeItem('GITHUB_PAT_SESSION'); } catch {}
      alert('Token removed.');
    }
    // 即時重試
    dataLoaded = false; cachedResults = [];
    showLoading(); await loadWeeklyStars(); renderMetaDates();
  });

  init();
</script>

  </body>
</html>
