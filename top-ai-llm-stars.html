<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top LLM &amp; AI GitHub Stars (Monthly)</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-base: #070b16;
        --bg-panel: rgba(15, 23, 42, 0.86);
        --accent: #38bdf8;
        --accent-strong: #22d3ee;
        --text: #e2e8f0;
        --text-soft: rgba(226, 232, 240, 0.75);
        --border: rgba(148, 163, 184, 0.28);
        font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
        padding: clamp(20px, 5vw, 48px);
        background:
          radial-gradient(circle at 12% 18%, rgba(56, 189, 248, 0.22), transparent 60%),
          radial-gradient(circle at 88% 12%, rgba(129, 140, 248, 0.16), transparent 62%),
          linear-gradient(140deg, #020617 0%, #0f172a 60%, #1e293b 100%);
        color: var(--text);
      }

      main {
        width: min(920px, 100%);
        background: var(--bg-panel);
        border-radius: 28px;
        border: 1px solid var(--border);
        box-shadow: 0 28px 60px rgba(2, 6, 23, 0.45);
        padding: clamp(24px, 4vw, 44px);
        backdrop-filter: blur(18px);
        position: relative;
      }

      .filters {
        display:flex; flex-wrap:wrap; gap:12px; margin: 8px 0 28px 0; align-items:flex-end;
      }
      .filters .field { display:flex; flex-direction:column; gap:6px; }
      .filters label { font-size:.7rem; letter-spacing:.08em; text-transform:uppercase; opacity:.7; }
      .filters input, .filters select { background:rgba(15,23,42,.7); color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:8px; font:inherit; }
      .filters button.action { padding:9px 16px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
      .filters button.secondary { padding:9px 14px; border:1px solid var(--border); background:rgba(15,23,42,.5); color:var(--text-soft); border-radius:8px; cursor:pointer; }
      .filters button.action:hover { background:var(--accent-strong); }
      .filters button.secondary:hover { color:var(--text); }
  .filters .inline-row { display:flex; align-items:center; gap:8px; }
  mark.match { background:rgba(250,204,21,.25); color:var(--accent-strong); padding:0 2px; border-radius:3px; }

  /* Saved topics UI */
  .saved-topics{ margin:-4px 0 24px 0; display:flex; flex-direction:column; gap:10px; }
  .saved-topics .st-header{ display:flex; align-items:center; gap:10px; font-size:.72rem; letter-spacing:.08em; text-transform:uppercase; opacity:.75; }
  .saved-topics .mini-btn{ background:rgba(15,23,42,.55); color:var(--text-soft); border:1px solid var(--border); padding:4px 10px; border-radius:6px; font-size:.65rem; cursor:pointer; font-weight:600; }
  .saved-topics .mini-btn:hover{ color:var(--text); border-color:rgba(148,163,184,.45); }
  .saved-topics .mini-btn.danger:hover{ border-color:#f87171; color:#f87171; }
  .topic-chips{ display:flex; flex-wrap:wrap; gap:8px; }
  .topic-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(56,189,248,.14); color:var(--accent); border:1px solid rgba(56,189,248,.35); border-radius:999px; font-size:.75rem; cursor:pointer; position:relative; }
  .topic-chip:hover{ background:rgba(56,189,248,.22); }
  .topic-chip button{ all:unset; cursor:pointer; font-size:.85em; line-height:1; padding:2px 4px; border-radius:6px; background:rgba(15,23,42,.4); color:var(--accent-strong); }
  .topic-chip button:hover{ background:rgba(239,68,68,.85); color:#fff; }

      header { display: flex; flex-direction: column; gap: 12px; margin-bottom: clamp(24px, 4vw, 36px); }

      /* top bar */
      .top-bar {
        position: absolute; top: clamp(16px, 3vw, 24px); right: clamp(16px, 3vw, 24px);
        display: flex; gap: 8px; justify-content: flex-end;
      }
      .chip-btn {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 8px 14px; border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.7);
        color: var(--text); cursor: pointer; font-size: 0.85rem; font-weight: 600;
        transition: border-color .18s ease, background .18s ease, color .18s ease;
      }
      .chip-btn:hover, .chip-btn:focus-visible { border-color: rgba(56, 189, 248, .6); color: var(--accent-strong); outline: none; }
      .chip-btn[data-kind="lang"] span { opacity: .6; transition: opacity .18s ease; }
      .chip-btn[data-kind="lang"] span[data-active="true"] { opacity: 1; }
      .chip-btn[data-kind="api"]{ font-variant: all-small-caps; letter-spacing: .04em; }

      .breadcrumb{ font-size:.85rem;color:var(--text-soft);display:inline-flex;gap:8px;align-items:center; }
      .breadcrumb a{ color:var(--accent); text-decoration:none; font-weight:600; }
      .breadcrumb a:hover{ text-decoration:underline; }

      h1{ margin:0; font-size:clamp(2rem,4.8vw,2.6rem); font-weight:700; }
      .lead{ margin:0; font-size:1rem; color:var(--text-soft); line-height:1.6; max-width:680px; }

      .snapshot-meta{ display:flex; flex-wrap:wrap; gap:12px; margin:clamp(16px,3vw,24px) 0; font-size:.86rem; color:rgba(148,163,184,.85); align-items:center; }
      .snapshot-meta span{
        display:inline-flex; align-items:center; gap:6px; background:rgba(15,23,42,.68);
        border-radius:999px; padding:6px 12px; border:1px solid rgba(148,163,184,.24);
      }
      .snapshot-meta select, .snapshot-meta button.export-btn { background:rgba(15,23,42,.68); color:var(--text); border:1px solid rgba(148,163,184,.24); border-radius:999px; padding:6px 12px; font:inherit; font-size:.75rem; cursor:pointer; }
      .snapshot-meta button.export-btn:hover, .snapshot-meta select:hover { border-color:rgba(56,189,248,.55); }
      .mode-badge{ background:linear-gradient(135deg,#0f172a,#1e293b); border:1px solid rgba(56,189,248,.4)!important; color:var(--accent); font-weight:600; }
      .delta{ font-size:.7rem; margin-left:6px; font-weight:600; }
      .delta.pos{ color:#10b981; }
      .delta.neg{ color:#f87171; }
      .hot-topics{ display:flex; flex-wrap:wrap; gap:8px; margin:0 0 16px 0; }
      .hot-topics .hot-btn{ background:rgba(56,189,248,.14); border:1px solid rgba(56,189,248,.35); color:var(--accent); padding:6px 14px; border-radius:999px; font-size:.7rem; cursor:pointer; font-weight:600; letter-spacing:.05em; }
      .hot-topics .hot-btn:hover{ background:rgba(56,189,248,.24); }

      table{ width:100%; border-collapse:collapse; background:rgba(15,23,42,.7); border-radius:22px; overflow:hidden; border:1px solid rgba(148,163,184,.26); }
      thead{ background:rgba(15,23,42,.9); }
      th,td{ padding:clamp(14px,2.8vw,18px); text-align:left; border-bottom:1px solid rgba(148,163,184,.18); }
      th{ font-size:.78rem; letter-spacing:.08em; text-transform:uppercase; color:rgba(148,163,184,.8); }
      tbody tr:last-child td{ border-bottom:none; }
      tbody tr:hover{ background:rgba(30,64,175,.18); }
  tbody tr{ transition: background .18s ease, transform .18s ease, box-shadow .25s ease; }
  tbody tr:hover{ transform:translateY(-2px); box-shadow:0 6px 18px -6px rgba(0,0,0,.5); }
  tbody td{ vertical-align:top; }

  /* Modern card feel inside table */
  tbody tr{ backdrop-filter:blur(6px); }
  .repo a{ font-size:1rem; letter-spacing:.3px; }
  .repo .tags{ margin-top:2px; }
  .stars-badge{ display:inline-flex; align-items:center; gap:4px; background:linear-gradient(135deg,#0f172a,#1e293b); padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:600; color:var(--accent); border:1px solid rgba(56,189,248,.35); }
  .stars-badge svg{ width:14px; height:14px; }

  /* Translation toggle chip icon state */
  .chip-btn[data-active="true"]{ border-color:rgba(56,189,248,.7); color:var(--accent-strong); }

      .repo{ display:flex; flex-direction:column; gap:6px; }
      .repo a{ color:var(--accent); font-weight:600; text-decoration:none; }
      .repo a:hover{ text-decoration:underline; }

      .tags{ display:inline-flex; flex-wrap:wrap; gap:6px; font-size:.75rem; color:rgba(148,163,184,.85); }
      .tag-chip{
        display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px;
        background:rgba(56,189,248,.14); border:1px solid rgba(56,189,248,.3); color:var(--accent);
      }

      .loading-state{ display:flex; align-items:center; justify-content:center; gap:12px; padding:28px 18px; color:rgba(148,163,184,.8); font-size:.95rem; }
      .loading-state .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(148,163,184,.28); border-top-color:var(--accent); animation:spin 1s linear infinite; }
      @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

      .footnote{ margin-top:clamp(22px,4vw,32px); font-size:.85rem; color:rgba(148,163,184,.85); line-height:1.6; }

      @media (max-width: 720px){
        main{ padding-top:clamp(60px,12vw,72px); }
        table, thead, tbody, th, td, tr{ display:block; }
        thead{ display:none; }
        tbody tr{ border-bottom:1px solid rgba(148,163,184,.18); padding:18px 0; }
        tbody tr:last-child{ border-bottom:none; }
        td{ border:none; padding:6px 0; }
        td::before{
          content:attr(data-label); display:block; font-size:.75rem; text-transform:uppercase;
          color:rgba(148,163,184,.72); margin-bottom:4px; letter-spacing:.08em;
        }
        .repo{ gap:4px; }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="top-bar">
        <button type="button" class="chip-btn" data-kind="lang" data-lang-toggle aria-label="Switch language">
          <span data-lang-code="en" data-active="true">EN</span> / <span data-lang-code="zh-HK">繁</span>
        </button>
        <button type="button" class="chip-btn" data-kind="api" id="tokenBtn" title="Set GitHub API Token">API</button>
  <button type="button" class="chip-btn" id="geminiBtn" title="Set Gemini API Key for better zh-HK translation">Gemini</button>
  <button type="button" class="chip-btn" id="translateDynBtn" title="Toggle AI translation (Gemini) for descriptions">翻譯AI</button>
        <button type="button" class="chip-btn" id="modeBadge" title="Toggle mode: auto → live → static">Mode: auto</button>
      </div>
      <div class="saved-topics" aria-label="Saved topics section">
        <div class="st-header">
          <span>Saved Topics</span>
          <button id="addTopicBtn" class="mini-btn" title="Save current topic">+ Save</button>
          <button id="clearTopicsBtn" class="mini-btn danger" title="Remove all saved topics">Clear</button>
        </div>
        <div id="topicChips" class="topic-chips" aria-live="polite"></div>
      </div>
      <div class="hot-topics" aria-label="Hot topics quick access" id="hotTopicsBar"></div>
      <div class="filters" aria-label="Search & filters">
        <div class="field" style="flex:2 1 180px;">
          <label for="topicInput">Topic / Keyword</label>
          <input id="topicInput" type="text" placeholder="e.g. llm, ai, agent, python" />
        </div>
        <div class="field" style="width:90px;">
          <label for="minStars">Min Stars</label>
          <input id="minStars" type="number" min="0" value="1" />
        </div>
        <div class="field" style="width:110px;">
          <label for="maxRowsSel">Max Rows</label>
          <select id="maxRowsSel">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
        <div class="field" style="flex:0 0 auto; gap:8px;">
          <button id="searchBtn" class="action">Search</button>
          <button id="resetBtn" class="secondary" title="Reset filters">Reset</button>
          <div class="inline-row" style="margin-top:4px;">
            <input type="checkbox" id="strictMatch" />
            <label for="strictMatch" style="font-size:.65rem; letter-spacing:.08em; opacity:.65; cursor:pointer;">Name+Desc only</label>
          </div>
        </div>
      </div>

      <header style="margin:4px 0 14px 0;">
        <h1 data-i18n="heroTitle" style="margin:0 0 6px 0; font-size:1.9rem;">Top LLM &amp; AI GitHub Stars</h1>
        <div class="snapshot-meta" style="gap:8px; padding:2px 0;">
          <label style="display:inline-flex; align-items:center; gap:4px;">
            <span style="font-size:.65rem; opacity:.6;">Snapshot</span>
            <select id="snapshotSelect"><option value="">latest</option></select>
          </label>
          <button class="export-btn" id="exportJson" title="Export visible rows as JSON">JSON</button>
          <button class="export-btn" id="exportCsv" title="Export visible rows as CSV">CSV</button>
        </div>
      </header>

      <table role="table">
        <thead>
          <tr>
            <th scope="col" data-i18n="thRepository">Repository</th>
            <th scope="col" data-i18n="thHighlights">Highlights</th>
            <th scope="col" data-i18n="thStars">Stars (since launch)</th>
          </tr>
        </thead>
        <tbody data-results>
          <tr>
            <td colspan="3">
              <div class="loading-state" role="status">
                <span class="spinner" aria-hidden="true"></span>
                <span data-i18n="loading">Fetching live repositories…</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <p class="footnote" data-i18n="footnote" style="display:none;"></p>

      <noscript>
        <p class="footnote">Enable JavaScript to load the latest weekly LLM and AI repositories from GitHub.</p>
      </noscript>
    </main>

<script>
  /* ===== i18n strings ===== */
  // Added monthly mode, snapshot history, export, star delta, queries saved, hot topics
  const LOCALE_STORAGE_KEY = 'ideaHubLocale';
  const DEFAULT_LOCALE = 'en';
  const SUPPORTED_LOCALES = ['en', 'zh-HK'];
  const localeFallbacks = { en: 'en', 'zh-HK': 'zh-Hant-HK' };

  const translations = {
    en: {
  pageTitle: 'Top LLM & AI GitHub Stars (Monthly)',
      toggleAria: 'Switch to Traditional Chinese',
      breadcrumbHome: '',
      breadcrumbCurrent: '',
      heroTitle: 'Top LLM & AI GitHub Stars',
      heroLead: '',
      metaSource: '',
      metaUpdatedPrefix: '',
      thRepository: 'Repository',
      thHighlights: 'Highlights',
      thStars: 'Stars (since launch)',
      loading: 'Fetching live repositories…',
      noResults: 'No repositories matched the filters this week. Check back soon!',
      genericError: 'Something went wrong. Please try again later.',
      noDescription: 'No description provided.',
      footnote:
        "Data refreshes automatically (live) or via static pre-generated snapshots using a rolling 30-day window. If the API rate limit is reached, supply a token with <code>?token=&lt;your-token&gt;</code>.",
    },
    'zh-HK': {
      pageTitle: '每週 LLM 與 AI GitHub 星標排行榜',
      toggleAria: '切換至英文',
      breadcrumbHome: '',
      breadcrumbCurrent: '',
      heroTitle: '30 日 LLM 與 AI GitHub 星標排行榜',
      heroLead: '',
      metaSource: '',
      metaUpdatedPrefix: '',
      thRepository: '儲存庫',
      thHighlights: '重點',
      thStars: '星標（累計）',
      loading: '正在擷取最新儲存庫…',
      noResults: '本週沒有符合條件的儲存庫，稍後再來看看！',
      genericError: '載入時發生問題，請稍後再試。',
      noDescription: '沒有提供描述。',
      footnote:
        '頁面會即時或透過預先產生的靜態快照更新，採 30 日滾動視窗。若遇 API 限制，可於網址加上 <code>?token=&lt;your-token&gt;</code> 使用個人存取權杖。',
    },
  };

  let keywords = ['llm', 'language model', 'agent', 'agents', 'langchain', 'rag', 'vector', 'transformer', 'ai'];
  let maxRows = 5; // user adjustable
  const HOT_TOPICS = ['llm','agent','rag','tts','voice'];
  let forceMode = 'auto'; // auto | live | static
  let previousStarsMap = {}; // from latest.json previous_stars
  let queriesSavedEstimate = 0;

  const langToggle = document.querySelector('[data-lang-toggle]');
  const tokenBtn   = document.getElementById('tokenBtn');
  const resultsBody = document.querySelector('[data-results]');
  const weekRangeLabel = document.querySelector('[data-week-range]');
  const lastUpdatedLabel = document.querySelector('[data-last-updated]');

  let currentLocale = DEFAULT_LOCALE;
  let cachedResults = [];
  let dataLoaded = false;
  let translateDynamic = false; // experimental zh-HK toggle
  const SAVED_TOPICS_KEY = 'savedTopicsV1';

  /* ===== Token helpers ===== */
  const TOKEN_KEYS = ['GITHUB_PAT_SESSION', 'GITHUB_PAT_LOCAL'];

  // 捕捉 ?token=...（存 sessionStorage，再清 URL）
  (function captureTokenFromURL(){
    const params = new URLSearchParams(location.search);
    const t = params.get('token');
    if (t) {
      try { sessionStorage.setItem(TOKEN_KEYS[0], t.trim()); } catch {}
      const clean = location.pathname + location.hash;
      history.replaceState({}, '', clean);
    }
  })();

  function getAuthToken(){
    return sessionStorage.getItem(TOKEN_KEYS[0]) || localStorage.getItem(TOKEN_KEYS[1]) || null;
  }
  function setAuthTokenLocal(t){
    if (t) localStorage.setItem(TOKEN_KEYS[1], t.trim());
    else   localStorage.removeItem(TOKEN_KEYS[1]);
  }

  async function validateToken(){
    const token = getAuthToken();
    if (!token) return { ok: false, status: 0, message: 'no token' };

    try{
      const res = await fetch('https://api.github.com/rate_limit', {
        headers: {
          Accept: 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
          Authorization: `Bearer ${token}`,
        }
      });
      const body = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, message: body.message || 'OK' };
    }catch(e){
      return { ok: false, status: -1, message: String(e) };
    }
  }

  /* ===== i18n render ===== */
  function getStoredLocale(){
    const stored = localStorage.getItem(LOCALE_STORAGE_KEY);
    return SUPPORTED_LOCALES.includes(stored) ? stored : DEFAULT_LOCALE;
  }
  function persistLocale(locale){ localStorage.setItem(LOCALE_STORAGE_KEY, locale); }
  function applyLocaleToDocument(locale){ document.documentElement.lang = localeFallbacks[locale] || 'en'; }
  function updateToggleVisual(locale){
    langToggle?.setAttribute('aria-label', translations[locale].toggleAria);
    langToggle?.querySelectorAll('span').forEach((span) => {
      span.dataset.active = span.dataset.langCode === locale ? 'true' : 'false';
    });
  }
  function renderStaticCopy(){
    Object.entries(translations[currentLocale]).forEach(([key, value]) => {
      document.querySelectorAll(`[data-i18n="${key}"]`).forEach((node) => {
        if (key === 'footnote') node.innerHTML = value; else node.textContent = value;
      });
    });
  }
  function formatDate(date, options = {}){
    return new Intl.DateTimeFormat(localeFallbacks[currentLocale] || 'en',
      { day:'numeric', month:'short', year:'numeric', ...options }).format(date);
  }
  function formatCompact(n){
    return new Intl.NumberFormat(localeFallbacks[currentLocale] || 'en',
      { notation:'compact', maximumFractionDigits:1 }).format(n);
  }
  function formatTag(label){
    return label.replace(/[-_]/g,' ').replace(/\b\w/g, m => m.toUpperCase());
  }
  function renderMetaDates(){}

  /* ===== UI states ===== */
  function showLoading(){
    resultsBody.innerHTML = `
      <tr><td colspan="3">
        <div class="loading-state" role="status">
          <span class="spinner" aria-hidden="true"></span>
          <span>${translations[currentLocale].loading}</span>
        </div>
      </td></tr>`;
  }
  function showErrorLine(text){
    resultsBody.innerHTML = `
      <tr><td colspan="3">
        <div class="loading-state"><span aria-hidden="true">⚠️</span><span>${text}</span></div>
      </td></tr>`;
  }
  function showError(messageKey){
    const msg = (messageKey === 'noResults') ? translations[currentLocale].noResults : translations[currentLocale].genericError;
    showErrorLine(msg);
  }

  /* ===== GitHub search ===== */
  function repoIsRelevant(repo){
    const haystack = [repo.name, repo.full_name, repo.description || '', ...(repo.topics || [])]
      .join(' ').toLowerCase();
    return keywords.some(k => haystack.includes(k));
  }

  function createRow(repo){
    const tr = document.createElement('tr');

    const repoCell = document.createElement('td');
    repoCell.dataset.label = translations[currentLocale].thRepository;
  // simplified: no highlight
  const nameDisplay = repo.full_name;
    repoCell.innerHTML = `
      <div class="repo">
        <a href="${repo.html_url}" target="_blank" rel="noopener">${nameDisplay}</a>
        <div class="tags"></div>
      </div>`;
    const tags = repoCell.querySelector('.tags');
    const tagSet = new Set();
    (repo.topics || []).forEach(t => { if (tagSet.size < 3) tagSet.add(formatTag(t)); });
    if (!tagSet.size){
      const fallback = repo.language ? [repo.language] : [];
      [...fallback, 'AI', 'LLM'].forEach(t => { if (tagSet.size < 3) tagSet.add(formatTag(t)); });
    }
    tagSet.forEach(t => { const s = document.createElement('span'); s.className='tag-chip'; s.textContent=t; tags.appendChild(s); });

    const hi = document.createElement('td');
    hi.dataset.label = translations[currentLocale].thHighlights;
    hi.textContent = repo.description ? repo.description.trim() : translations[currentLocale].noDescription;

  const stars = document.createElement('td');
  stars.dataset.label = translations[currentLocale].thStars;
  stars.innerHTML = `<span class="stars-badge" title="Total stars">${formatCompact(repo.stargazers_count)}★</span>`;

    tr.append(repoCell, hi, stars);
    return tr;
  }

  /* ===== AI Translation (Gemini) zh-HK ===== */
  const GEMINI_KEY_STORAGE = 'GEMINI_KEY_LOCAL_V1';
  function getGeminiKey(){ try { return localStorage.getItem(GEMINI_KEY_STORAGE) || ''; } catch { return ''; } }
  function setGeminiKey(v){ try { if(v) localStorage.setItem(GEMINI_KEY_STORAGE, v); else localStorage.removeItem(GEMINI_KEY_STORAGE);}catch{} }
  async function translateDescriptionsGemini(){
    if(currentLocale !== 'zh-HK'){ alert('請先切換語言到 繁 (ZH-HK) 再啟用翻譯'); translateDynamic=false; return; }
    const key = getGeminiKey();
    if(!key){ alert('請先設定 Gemini API Key'); return; }
    const btn = document.getElementById('translateDynBtn');
    const rows = Array.from(document.querySelectorAll('[data-results] tr'));
    const toTranslate = rows.map(r => {
      const td = r.querySelector('td:nth-child(2)');
      if(!td) return null;
      if(!td.dataset.orig) td.dataset.orig = td.textContent;
      // skip if already translated
      if(td.dataset.aiTranslated === '1') return null;
      return td;
    }).filter(Boolean);
    if(!toTranslate.length){ return; }
    if(btn){ btn.textContent='翻譯中…'; btn.disabled=true; }
    for(const td of toTranslate){
      const original = td.dataset.orig || td.textContent || '';
      if(!original.trim()){ td.dataset.aiTranslated='1'; continue; }
      td.style.opacity = '.5';
      try {
        const body = {
          contents:[{parts:[{text:`Translate the following repository description into Traditional Chinese (Hong Kong locale). Keep technical terms (like model names) in English. Return ONLY the translated sentence.\n\n${original}` }]}]
        };
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();
        const translated = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        if(translated){ td.textContent = translated; td.dataset.aiTranslated='1'; }
      }catch(e){ console.warn('Gemini translation failed', e); td.dataset.aiTranslated='err'; }
      finally { td.style.opacity=''; }
      // small delay to be polite
      await new Promise(r=>setTimeout(r,400));
      if(!translateDynamic) break; // user toggled off mid-way
    }
    if(btn){ btn.textContent = translateDynamic ? '翻譯AI(開)' : '翻譯AI'; btn.disabled=false; }
  }
  function applyDynamicTranslation(){
    if(!translateDynamic){ // restore
      document.querySelectorAll('[data-results] tr td:nth-child(2)').forEach(td => {
        if(td.dataset.orig) td.textContent = td.dataset.orig;
      });
      const b=document.getElementById('translateDynBtn'); if(b){ b.textContent='翻譯AI'; b.disabled=false; }
      return;
    }
    const b=document.getElementById('translateDynBtn'); if(b){ b.textContent='翻譯AI(開)'; }
    translateDescriptionsGemini();
  }

  async function fetchQuery(query, {useAuth=true} = {}){
    const params = new URLSearchParams({ q: query, sort: 'stars', order: 'desc', per_page: '20' });
    const headers = {
      Accept: 'application/vnd.github+json',
      'X-GitHub-Api-Version': '2022-11-28',
    };
    const token = getAuthToken();
    if (useAuth && token) headers.Authorization = `Bearer ${token}`;

    const res = await fetch(`https://api.github.com/search/repositories?${params}`, { headers });
    let body = null;
    try { body = await res.json(); } catch {}

    if (!res.ok){
      const message = (body && (body.message || JSON.stringify(body))) || res.statusText || 'Unknown error';
      const err = new Error(`GitHub API error ${res.status}: ${message}`);
      err.status = res.status; err.payload = body;
      throw err;
    }
    return (body && body.items) || [];
  }

  let lastApiErrorText = '';

  function getFilterValues(){
    const topic = (document.getElementById('topicInput')?.value || '').trim();
    const minStarsVal = parseInt(document.getElementById('minStars')?.value || '1', 10) || 0;
    const maxRowsSel = parseInt(document.getElementById('maxRowsSel')?.value || '5', 10) || 5;
    return { topic, minStarsVal, maxRowsSel };
  }

  function normalizeDateInput(value){ return null; }

  async function loadWeeklyStars(topicOverride = null){
    const { topic, minStarsVal, maxRowsSel } = getFilterValues();
    maxRows = maxRowsSel;
    const minStars = minStarsVal < 0 ? 0 : minStarsVal;

    // Determine date window (default: last 30 days)
    const today = new Date();
    const endDate = today.toISOString().slice(0,10);
    const tmp = new Date(endDate + 'T00:00:00Z');
    tmp.setDate(tmp.getDate() - 30);
    const startDate = tmp.toISOString().slice(0,10);

    const chosenTopic = topicOverride !== null ? topicOverride : topic;
    const results = new Map();
    let searchKeywords = chosenTopic ? [chosenTopic] : keywords;
    // Use explicit range for created
    // Build queries: topic created:startDate..endDate stars:>=minStars
    let queries = searchKeywords.map(k => {
      let parts = [];
      if(k) parts.push(k);
      parts.push(`created:${startDate}..${endDate}`);
      if (minStars > 0) parts.push(`stars:>=${minStars}`);
      parts.push('in:name,description,readme');
      return parts.join(' ');
    });

    results.clear();
    const executed = new Set();
    for (const q of queries){
      try{
        const repos = await fetchQuery(q, {useAuth:true});
        repos.forEach(r => { if (!results.has(r.id)) results.set(r.id, r); });
        if(!executed.has(q)){ queriesSavedEstimate++; executed.add(q);} // approximate unique query count
      }catch(eAuth){
        console.warn('Auth search failed:', eAuth);
        lastApiErrorText = eAuth.message || String(eAuth);
        try{
          const repos = await fetchQuery(q, {useAuth:false});
          repos.forEach(r => { if (!results.has(r.id)) results.set(r.id, r); });
          if(!executed.has(q)){ queriesSavedEstimate++; executed.add(q);} 
        }catch(eAnon){
          console.warn('Anon search also failed:', eAnon);
          lastApiErrorText = eAnon.message || String(eAnon);
        }
      }
    }

    let arr = Array.from(results.values())
      .sort((a,b) => b.stargazers_count - a.stargazers_count);

    // strict client-side filter if requested
    const strict = document.getElementById('strictMatch')?.checked;
    if (strict && chosenTopic){
      const termLower = chosenTopic.toLowerCase();
      arr = arr.filter(r => (r.name && r.name.toLowerCase().includes(termLower)) || (r.description && r.description.toLowerCase().includes(termLower)) || (Array.isArray(r.topics) && r.topics.some(t => t.toLowerCase().includes(termLower))));
    }

    if (arr.length){
      cachedResults = arr.slice(0, maxRows);
    } else {
      cachedResults = [];
    }

    dataLoaded = true;
    if (!cachedResults.length){
      let reason = 'No repositories for this filter.';
      if (lastApiErrorText) reason += ` API: ${lastApiErrorText}`;
      showErrorLine(reason + ' Try broadening the topic, widening the date range, or lowering min stars.');
      return; }

    resultsBody.innerHTML = '';
  cachedResults.forEach(r => resultsBody.appendChild(createRow(r)));
  applyStarDelta();
    applyDynamicTranslation();
      applyDynamicTranslation();
    updateQueriesSaved();
  }

  /* ===== init & events ===== */
  function setLocale(locale, { rerenderOnly=false }={}){
    currentLocale = SUPPORTED_LOCALES.includes(locale) ? locale : DEFAULT_LOCALE;
    persistLocale(currentLocale);
    applyLocaleToDocument(currentLocale);
    updateToggleVisual(currentLocale);
    renderStaticCopy();
    document.title = translations[currentLocale].pageTitle;
    renderMetaDates();
    if (rerenderOnly){
      if (cachedResults.length){
        resultsBody.innerHTML = '';
        cachedResults.forEach(r => resultsBody.appendChild(createRow(r)));
      } else {
        showLoading();
      }
    }
  }

  async function init(){
    currentLocale = getStoredLocale();
    setLocale(currentLocale);
    showLoading();

    // 顯示 token 狀態（可自行用 console 查看）
    const v = await validateToken();
    if (!v.ok && v.status) {
      console.warn('Token invalid:', v.status, v.message);
    }
    // Try static snapshot first if no token & user hasn't specified a topic
    const staticLoaded = await tryLoadStaticIfNoToken();
    if(!staticLoaded){
      await loadWeeklyStars();
      // attempt to fetch previous snapshot map silently
      try{
        const res = await fetch('data/latest.json',{cache:'no-store'});
        if(res.ok){ const p = await res.json(); previousStarsMap = p.previous_stars || {}; applyStarDelta(); }
      }catch{}
      updateModeBadge('live');
    }
    renderMetaDates();

    // Add topic search event
    const topicInput = document.getElementById('topicInput');
    const searchBtn = document.getElementById('searchBtn');
  const resetBtn = document.getElementById('resetBtn');
  const translateDynBtn = document.getElementById('translateDynBtn');
  if (searchBtn) searchBtn.addEventListener('click', async () => { showLoading(); await loadWeeklyStars(); });
    if (topicInput) topicInput.addEventListener('keydown', async e => { if(e.key==='Enter'){ showLoading(); await loadWeeklyStars(); }});
  const strict = document.getElementById('strictMatch');
  if (strict) strict.addEventListener('change', async () => { showLoading(); await loadWeeklyStars(); });
    if (resetBtn) resetBtn.addEventListener('click', async () => {
      (document.getElementById('topicInput')||{}).value='';
      (document.getElementById('minStars')||{}).value='1';
      (document.getElementById('maxRowsSel')||{}).value='5';
      showLoading(); await loadWeeklyStars();
    });
    if (translateDynBtn){
      translateDynBtn.addEventListener('click', () => {
        translateDynamic = !translateDynamic;
        translateDynBtn.dataset.active = translateDynamic ? 'true' : 'false';
        applyDynamicTranslation();
      });
    }
    const geminiBtn = document.getElementById('geminiBtn');
    geminiBtn?.addEventListener('click', () => {
      const existing = getGeminiKey();
      const input = prompt('Enter Gemini API Key (stored locally). 留空刪除。', existing);
      if(input === null) return;
      const v = (input||'').trim();
      if(v){ setGeminiKey(v); alert('Saved'); }
      else { setGeminiKey(''); alert('Removed'); }
    });

    /* ===== Saved topics logic ===== */
    const topicChips = document.getElementById('topicChips');
    function loadSavedTopics(){
      try { return JSON.parse(localStorage.getItem(SAVED_TOPICS_KEY) || '[]'); } catch { return []; }
    }
    function persistTopics(list){ localStorage.setItem(SAVED_TOPICS_KEY, JSON.stringify(list)); }
    function renderSavedTopics(){
      if(!topicChips) return;
      const list = loadSavedTopics();
      topicChips.innerHTML = '';
      if(!list.length){
        const empty = document.createElement('div');
        empty.style.opacity = '.5'; empty.style.fontSize = '.7rem';
        empty.textContent = 'No saved topics';
        topicChips.appendChild(empty); return;
      }
      list.forEach(t => {
        const chip = document.createElement('span');
        chip.className = 'topic-chip';
        chip.dataset.topic = t;
        chip.innerHTML = `<span class="label">${t}</span><button type="button" aria-label="Delete ${t}" data-del>&times;</button>`;
        topicChips.appendChild(chip);
      });
    }
    function addTopic(t){
      t = (t||'').trim(); if(!t) return;
      let list = loadSavedTopics();
      if(!list.includes(t)){
        list.unshift(t);
        if(list.length > 30) list = list.slice(0,30); // cap
        persistTopics(list); renderSavedTopics();
      }
    }
    function removeTopic(t){
      let list = loadSavedTopics().filter(x => x !== t); persistTopics(list); renderSavedTopics();
    }

    const addTopicBtn = document.getElementById('addTopicBtn');
    const clearTopicsBtn = document.getElementById('clearTopicsBtn');
    addTopicBtn?.addEventListener('click', () => {
      const val = (document.getElementById('topicInput')?.value || '').trim();
      addTopic(val);
    });
    clearTopicsBtn?.addEventListener('click', () => {
      if(confirm('Clear all saved topics?')){ persistTopics([]); renderSavedTopics(); }
    });
    topicChips?.addEventListener('click', async (e) => {
      const target = e.target;
      if(!(target instanceof HTMLElement)) return;
      const chip = target.closest('.topic-chip');
      if(!chip) return;
      const topic = chip.dataset.topic;
      if(target.hasAttribute('data-del')){
        removeTopic(topic);
        return;
      } else {
        const input = document.getElementById('topicInput');
        if(input){ input.value = topic; }
        showLoading(); await loadWeeklyStars(topic);
      }
    });

    renderSavedTopics();
  }

  // Static snapshot fallback
  async function tryLoadStaticIfNoToken(){
    if (forceMode === 'live') return false;
    if (getAuthToken() && forceMode !== 'static') return false;
    const topic = (document.getElementById('topicInput')?.value||'').trim();
    if (topic) return false; // user wants live search
    try{
      const res = await fetch('data/latest.json', {cache:'no-store'});
      if(!res.ok) return false;
      const payload = await res.json();
      cachedResults = (payload.repos||[]).slice(0, maxRows);
      previousStarsMap = payload.previous_stars || {};
      if(!cachedResults.length){ return false; }
      resultsBody.innerHTML='';
      cachedResults.forEach(r=>resultsBody.appendChild(createRow(r)));
      const stamp = document.querySelector('[data-last-updated]');
      if (stamp && payload.generated_at){
        stamp.textContent = `${translations[currentLocale].metaUpdatedPrefix}${formatDate(new Date(payload.generated_at))} (static)`;
      }
      updateModeBadge('static');
      applyStarDelta();
      return true;
    }catch(e){
      console.warn('Static snapshot load failed', e);
      return false;
    }
  }

  function updateModeBadge(mode){
    const el = document.getElementById('modeBadge');
    if(!el) return; el.textContent = `Mode: ${mode}`;
  }

  function applyStarDelta(){
    // Add delta next to badge if previous exists
    document.querySelectorAll('[data-results] tr').forEach(tr => {
      const link = tr.querySelector('.repo a');
      const starsTd = tr.querySelector('td:last-child .stars-badge');
      if(!link || !starsTd) return;
  const fullName = link.textContent.trim();
      const currentStars = parseInt(starsTd.textContent,10) || 0;
      const prev = previousStarsMap[fullName];
      if(prev && prev !== currentStars){
        const delta = currentStars - prev;
        const span = document.createElement('span');
        span.className = 'delta ' + (delta>0?'pos':'neg');
        span.textContent = (delta>0?'+':'') + delta;
        starsTd.appendChild(span);
      }
    });
  }

  function exportJSON(){
    const data = JSON.stringify(cachedResults, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    download(url, 'stars-export.json');
  }
  function exportCSV(){
    if(!cachedResults.length){ alert('No data'); return; }
    const header = ['full_name','html_url','description','stargazers_count','language'];
    const rows = cachedResults.map(r=> header.map(h => JSON.stringify((r[h]||'').toString().replace(/"/g,'"'))).join(','));
    const csv = [header.join(','), ...rows].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    download(url, 'stars-export.csv');
  }
  function download(url, filename){ const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 5000); }

  function updateQueriesSaved(){
    const el = document.getElementById('queriesSaved'); if(!el) return;
    el.textContent = `Queries saved: ${queriesSavedEstimate}`;
  }

  async function loadSnapshotList(){
    try{
      const res = await fetch('data/snapshots/index.json',{cache:'no-store'});
      if(!res.ok) return;
      const list = await res.json();
      const sel = document.getElementById('snapshotSelect');
      if(!sel) return;
      list.slice().reverse().forEach(f => {
        const opt = document.createElement('option');
        opt.value = f; opt.textContent = f.replace('.json',''); sel.appendChild(opt);
      });
    }catch(e){ console.warn('snapshot index fail', e); }
  }

  async function loadSnapshotFile(name){
    if(!name){ showLoading(); await loadWeeklyStars(); return; }
    try{
      const res = await fetch('data/snapshots/'+name, {cache:'no-store'});
      if(!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      resultsBody.innerHTML='';
      cachedResults = data.slice(0,maxRows);
  cachedResults.forEach(r=>resultsBody.appendChild(createRow(r)));
      updateModeBadge('static');
  applyStarDelta();
    }catch(e){ alert('Failed to load snapshot'); }
  }

  function renderHotTopics(){
    const bar = document.getElementById('hotTopicsBar'); if(!bar) return;
    bar.innerHTML = '';
    HOT_TOPICS.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'hot-btn'; btn.textContent = t;
      btn.addEventListener('click', async () => {
        const input = document.getElementById('topicInput'); if(input) input.value = t;
        showLoading(); await loadWeeklyStars(t);
      });
      bar.appendChild(btn);
    });
  }

  // Mode toggle via clicking mode badge
  document.addEventListener('click', async (e)=>{
    const target = e.target; if(!(target instanceof HTMLElement)) return;
    if(target.id === 'modeBadge'){
      forceMode = forceMode === 'auto' ? 'live' : forceMode === 'live' ? 'static' : 'auto';
      updateModeBadge(forceMode);
      showLoading();
      if(forceMode === 'static'){
        const loaded = await tryLoadStaticIfNoToken();
        if(!loaded) showErrorLine('No static snapshot available.');
      } else {
        await loadWeeklyStars();
      }
    }
  });

  document.addEventListener('change', async (e)=>{
    const target = e.target; if(!(target instanceof HTMLElement)) return;
    if(target.id === 'snapshotSelect'){
      const val = target.value; await loadSnapshotFile(val);
    }
  });

  document.addEventListener('click', (e)=>{
    const target = e.target; if(!(target instanceof HTMLElement)) return;
    if(target.id === 'exportJson'){ exportJSON(); }
    if(target.id === 'exportCsv'){ exportCSV(); }
  });

  renderHotTopics();
  loadSnapshotList();

  langToggle?.addEventListener('click', () => {
    const next = currentLocale === 'en' ? 'zh-HK' : 'en';
    setLocale(next, { rerenderOnly: true });
  });

  tokenBtn?.addEventListener('click', async () => {
    const existing = getAuthToken() || '';
    const t = prompt('Paste your GitHub token (stored locally). Leave blank to remove.\n本機儲存，不會上傳到伺服器。', existing);
    if (t === null) return;
    const trimmed = t.trim();
    if (trimmed){
      setAuthTokenLocal(trimmed);
      alert('Saved locally. 將使用較高 API 配額。');
    } else {
      setAuthTokenLocal('');
      try { sessionStorage.removeItem('GITHUB_PAT_SESSION'); } catch {}
      alert('Token removed.');
    }
    // 即時重試
    dataLoaded = false; cachedResults = [];
    showLoading(); await loadWeeklyStars(); renderMetaDates();
  });

  init();
</script>

  </body>
</html>
